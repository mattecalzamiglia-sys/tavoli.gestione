<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@_muse.in_ - Cameriere</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }
        .call-pulse { position: relative; }
        .call-pulse::before { content: ''; position: absolute; inset: -8px; border-radius: 12px; border: 2px solid #f97316; animation: pulse-ring 1.5s infinite; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script>
        firebase.initializeApp({
            apiKey: "AIzaSyA-m6tX87TZtqTDg2kuE04zDvxkJ_vH2Yg",
            authDomain: "gestionale-discoteche-2026.firebaseapp.com",
            projectId: "gestionale-discoteche-2026",
            storageBucket: "gestionale-discoteche-2026.firebasestorage.app",
            messagingSenderId: "299126578946",
            appId: "1:299126578946:web:2609823671a0eed056ac1b"
        });
        const db = firebase.firestore();
        const { useState, useEffect, useRef } = React;
        const h = React.createElement;

        function App() {
            const [event, setEvent] = useState(null);
            const [tables, setTables] = useState([]);
            const [orders, setOrders] = useState([]);
            const [calls, setCalls] = useState([]);
            const [bookings, setBookings] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [tab, setTab] = useState('calls');
            const unsubs = useRef([]);

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const eventId = params.get('event');
                if (!eventId) { setError('Link non valido.'); setLoading(false); return; }

                (async () => {
                    try {
                        const eventDoc = await db.collection('events').doc(eventId).get();
                        if (!eventDoc.exists) { setError('Evento non trovato.'); setLoading(false); return; }
                        setEvent({ id: eventDoc.id, ...eventDoc.data() });

                        unsubs.current.push(db.collection('events').doc(eventId).collection('tables').onSnapshot(s => setTables(s.docs.map(d => ({id:d.id,...d.data()})))));
                        unsubs.current.push(db.collection('events').doc(eventId).collection('bookings').onSnapshot(s => setBookings(s.docs.map(d => ({id:d.id,...d.data()})))));
                        unsubs.current.push(db.collection('events').doc(eventId).collection('orders').onSnapshot(s => setOrders(s.docs.map(d => ({id:d.id,...d.data()})))));
                        unsubs.current.push(db.collection('events').doc(eventId).collection('waiterCalls').where('status','==','pending').onSnapshot(s => setCalls(s.docs.map(d => ({id:d.id,...d.data()})))));
                        setLoading(false);
                    } catch(e) { setError('Errore caricamento.'); setLoading(false); }
                })();
                return () => unsubs.current.forEach(u => u());
            }, []);

            const clearCall = async (cid) => {
                const params = new URLSearchParams(window.location.search);
                await db.collection('events').doc(params.get('event')).collection('waiterCalls').doc(cid).update({status:'completed',completedAt:new Date().toISOString()});
            };

            const timeSince = (date) => { const d = Math.floor((new Date()-new Date(date))/1000/60); return d<1?'Ora':d<60?d+'m fa':Math.floor(d/60)+'h '+d%60+'m'; };

            if (loading) return h('div', {className: 'min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex items-center justify-center'}, h('div', {className: 'animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-purple-500'}));
            if (error) return h('div', {className: 'min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex items-center justify-center p-4'}, h('div', {className: 'bg-red-500/20 border border-red-500/40 rounded-xl p-8 text-center'}, h('div', {className: 'text-6xl mb-4'}, 'âš ï¸'), h('p', {className: 'text-red-300'}, error)));

            return h('div', {className: 'min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900'},
                h('header', {className: 'sticky top-0 bg-slate-900/95 backdrop-blur-sm border-b border-purple-500/30 px-4 py-3 z-50'},
                    h('div', {className: 'flex justify-between items-center mb-3'},
                        h('div', {}, h('h1', {className: 'text-xl font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-cyan-400'}, 'ðŸ· Cameriere'), h('p', {className: 'text-purple-300 text-xs'}, event?.name)),
                        h('div', {className: 'text-green-400 text-xs'}, 'â— Real-time')
                    ),
                    h('div', {className: 'flex gap-2'},
                        h('button', {onClick:()=>setTab('calls'), className:`flex-1 py-2 rounded-lg font-bold text-sm flex items-center justify-center gap-2 ${tab==='calls'?'bg-orange-500 text-white':'bg-slate-800 text-purple-300'}`}, 'ðŸ”” Chiamate', calls.length>0 && h('span', {className:'bg-white text-orange-600 text-xs px-2 rounded-full'}, calls.length)),
                        h('button', {onClick:()=>setTab('orders'), className:`flex-1 py-2 rounded-lg font-bold text-sm ${tab==='orders'?'bg-pink-500 text-white':'bg-slate-800 text-purple-300'}`}, 'ðŸ¾ Ordini'),
                        h('button', {onClick:()=>setTab('tables'), className:`flex-1 py-2 rounded-lg font-bold text-sm ${tab==='tables'?'bg-purple-500 text-white':'bg-slate-800 text-purple-300'}`}, 'ðŸª‘ Tavoli')
                    )
                ),
                h('main', {className: 'p-4 pb-24'},
                    tab === 'calls' && h('div', {className: 'space-y-3'},
                        calls.length === 0 ? h('div', {className: 'text-center py-16'}, h('div', {className: 'text-6xl mb-4'}, 'ðŸ””'), h('p', {className: 'text-white font-bold'}, 'Nessuna chiamata'), h('p', {className: 'text-purple-300 text-sm'}, 'Le chiamate appariranno qui'))
                        : calls.sort((a,b)=>new Date(a.createdAt)-new Date(b.createdAt)).map(call =>
                            h('div', {key: call.id, className: 'call-pulse bg-orange-500/20 border-2 border-orange-400 rounded-xl p-4'},
                                h('div', {className: 'flex justify-between items-start mb-3'},
                                    h('div', {}, h('span', {className: 'text-3xl font-black text-white'}, 'Tavolo ', call.tableNumber), h('p', {className: 'text-orange-200 text-sm mt-1'}, timeSince(call.createdAt))),
                                    h('span', {className: 'text-2xl'}, 'ðŸ””')
                                ),
                                h('button', {onClick: ()=>clearCall(call.id), className: 'w-full bg-green-500 text-white py-3 rounded-lg font-bold text-lg'}, 'âœ“ Servito')
                            )
                        )
                    ),
                    tab === 'orders' && h('div', {className: 'space-y-3'},
                        h('h2', {className: 'text-white font-bold'}, 'Ordini Recenti'),
                        orders.length === 0 ? h('p', {className: 'text-purple-300 text-center py-16'}, 'Nessun ordine')
                        : [...orders].sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt)).slice(0,30).map(order => {
                            const table = tables.find(t => t.id === order.tableId);
                            return h('div', {key: order.id, className: 'bg-slate-800/50 border border-purple-500/30 rounded-xl p-4'},
                                h('div', {className: 'flex justify-between items-start mb-2'},
                                    h('div', {}, h('span', {className: 'text-white font-bold'}, 'Tavolo ', table?.number||'?'), h('p', {className: 'text-purple-300 text-xs'}, timeSince(order.createdAt))),
                                    h('span', {className: 'text-yellow-400 font-bold'}, 'â‚¬', order.total?.toFixed(2))
                                ),
                                h('div', {className: 'bg-slate-900/50 rounded-lg p-2 text-white'}, order.quantity, 'x ', order.productName)
                            );
                        })
                    ),
                    tab === 'tables' && h('div', {className: 'space-y-3'},
                        tables.sort((a,b)=>a.number-b.number).map(table => {
                            const booking = bookings.find(b => b.tableId === table.id);
                            const tableOrders = orders.filter(o => o.tableId === table.id);
                            const total = tableOrders.reduce((s,o) => s+(o.total||0), 0);
                            const hasCall = calls.some(c => c.tableId === table.id);
                            return h('div', {key: table.id, className: `rounded-xl p-4 border-2 ${hasCall?'bg-orange-500/20 border-orange-400':booking?'bg-green-500/10 border-green-500/40':'bg-slate-800/50 border-purple-500/30'}`},
                                h('div', {className: 'flex justify-between items-start'},
                                    h('div', {},
                                        h('span', {className: 'text-white font-bold text-xl'}, 'Tavolo ', table.number, hasCall && ' ðŸ””'),
                                        booking ? h('p', {className: 'text-green-300 text-sm'}, 'ðŸ‘¤ ', booking.guestName) : h('p', {className: 'text-purple-400 text-sm'}, 'Libero â€¢ ', table.capacity, ' posti')
                                    ),
                                    total > 0 && h('div', {className: 'text-right'}, h('div', {className: 'text-yellow-400 font-bold'}, 'â‚¬', total.toFixed(2)), h('div', {className: 'text-purple-300 text-xs'}, tableOrders.length, ' ordini'))
                                )
                            );
                        })
                    )
                ),
                calls.length > 0 && tab !== 'calls' && h('button', {onClick:()=>setTab('calls'), className: 'fixed bottom-6 right-6 bg-orange-500 text-white px-6 py-4 rounded-full shadow-lg flex items-center gap-2 animate-bounce'}, 'ðŸ”” ', calls.length)
            );
        }
        ReactDOM.render(h(App), document.getElementById('root'));
    </script>
</body>
</html>
