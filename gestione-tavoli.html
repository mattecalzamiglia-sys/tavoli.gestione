<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@_muse.in_ - Gestione Tavoli</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA-m6tX87TZtqTDg2kuE04zDvxkJ_vH2Yg",
            authDomain: "gestionale-discoteche-2026.firebaseapp.com",
            projectId: "gestionale-discoteche-2026",
            storageBucket: "gestionale-discoteche-2026.firebasestorage.app",
            messagingSenderId: "299126578946",
            appId: "1:299126578946:web:2609823671a0eed056ac1b",
            measurementId: "G-MK1GS1ZBL8"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    </script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, sans-serif;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(100, 100, 100, 0.1);
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(168, 85, 247, 0.5);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(168, 85, 247, 0.7);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Lucide Icons components
        const Plus = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M5 12h14"/><path d="M12 5v14"/>
            </svg>
        );

        const Edit3 = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
            </svg>
        );

        const Save = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/>
            </svg>
        );

        const X = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
            </svg>
        );

        const Users = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
        );

        const Calendar = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h18"/>
            </svg>
        );

        const MapPin = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/>
            </svg>
        );

        const ChevronLeft = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="m15 18-6-6 6-6"/>
            </svg>
        );

        const Trash2 = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/>
            </svg>
        );

        const Phone = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
            </svg>
        );

        const StickyNote = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M15.5 3H5a2 2 0 0 0-2 2v14c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2V8.5L15.5 3Z"/><path d="M15 3v6h6"/>
            </svg>
        );

        const Upload = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/>
            </svg>
        );

        const Package = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/>
            </svg>
        );

        const UserCheck = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><polyline points="16 11 18 13 22 9"/>
            </svg>
        );

        const Clock = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
            </svg>
        );

        const Minus = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M5 12h14"/>
            </svg>
        );

        const AlertTriangle = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/>
            </svg>
        );

        const Download = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/>
            </svg>
        );

        const Search = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/>
            </svg>
        );

        const CheckCircle = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
        );

        const Loader = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
            </svg>
        );

        // Firebase Firestore wrapper - Real-time sync
        const db = firebase.firestore();
        
        const firebaseStorage = {
            // Get document from Firestore
            async get(collection, docId) {
                try {
                    const doc = await db.collection(collection).doc(docId).get();
                    if (doc.exists) {
                        return { id: doc.id, ...doc.data() };
                    }
                    return null;
                } catch (error) {
                    console.error('Firebase get error:', error);
                    return null;
                }
            },
            
            // Set/Update document in Firestore
            async set(collection, docId, data) {
                try {
                    await db.collection(collection).doc(docId).set(data, { merge: true });
                    return { id: docId, ...data };
                } catch (error) {
                    console.error('Firebase set error:', error);
                    return null;
                }
            },
            
            // Delete document from Firestore
            async delete(collection, docId) {
                try {
                    await db.collection(collection).doc(docId).delete();
                    return { id: docId, deleted: true };
                } catch (error) {
                    console.error('Firebase delete error:', error);
                    return null;
                }
            },
            
            // Get all documents from a collection
            async getAll(collection) {
                try {
                    const snapshot = await db.collection(collection).get();
                    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (error) {
                    console.error('Firebase getAll error:', error);
                    return [];
                }
            },
            
            // Subscribe to real-time updates
            subscribe(collection, docId, callback) {
                return db.collection(collection).doc(docId).onSnapshot(doc => {
                    if (doc.exists) {
                        callback({ id: doc.id, ...doc.data() });
                    } else {
                        callback(null);
                    }
                });
            },
            
            // Subscribe to collection updates
            subscribeCollection(collection, callback) {
                return db.collection(collection).onSnapshot(snapshot => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    callback(data);
                });
            }
        };

        window.firebaseStorage = firebaseStorage;
        window.db = db;

        const EventTablesManager = () => {
            const [events, setEvents] = useState([]);
            const [currentEvent, setCurrentEvent] = useState(null);
            const [tables, setTables] = useState([]);
            const [bookings, setBookings] = useState([]);
            const [prs, setPrs] = useState([]);
            const [guestLists, setGuestLists] = useState([]);
            const [editMode, setEditMode] = useState(false);
            const [showNewEvent, setShowNewEvent] = useState(false);
            const [showNewPr, setShowNewPr] = useState(false);
            const [showPrView, setShowPrView] = useState(false);
            const [showOrdersView, setShowOrdersView] = useState(false);
            const [showMenuEditor, setShowMenuEditor] = useState(false);
            const [showImportGuests, setShowImportGuests] = useState(false);
            const [menu, setMenu] = useState([]);
            const [orders, setOrders] = useState([]);
            const [waiterCalls, setWaiterCalls] = useState([]);
            const [inventory, setInventory] = useState([]);
            const [staff, setStaff] = useState([]);
            const [showInventoryView, setShowInventoryView] = useState(false);
            const [showStaffView, setShowStaffView] = useState(false);
            const [selectedPr, setSelectedPr] = useState(null);
            const [selectedTable, setSelectedTable] = useState(null);
            const [draggedTable, setDraggedTable] = useState(null);
            const [resizingTable, setResizingTable] = useState(null);
            const [resizeStart, setResizeStart] = useState(null);
            const [editingTable, setEditingTable] = useState(null);
            const [loading, setLoading] = useState(true);
            
            // New states for enhanced features
            const [inventoryFilter, setInventoryFilter] = useState('');
            const [staffFilter, setStaffFilter] = useState('');
            const [orderFilter, setOrderFilter] = useState('all'); // all, pending, preparing, served
            const [deleteConfirm, setDeleteConfirm] = useState(null); // { type: 'staff'|'inventory'|'menu', id, name }
            const [showAddMenuModal, setShowAddMenuModal] = useState(false);
            
            const floorPlanRef = useRef(null);
            const unsubscribeRefs = useRef([]);

            // Cleanup subscriptions on unmount
            useEffect(() => {
                return () => {
                    unsubscribeRefs.current.forEach(unsub => unsub && unsub());
                };
            }, []);

            useEffect(() => {
                loadEvents();
            }, []);

            useEffect(() => {
                if (currentEvent) {
                    setupRealtimeListeners(currentEvent.id);
                }
                return () => {
                    // Cleanup previous listeners when event changes
                    unsubscribeRefs.current.forEach(unsub => unsub && unsub());
                    unsubscribeRefs.current = [];
                };
            }, [currentEvent]);

            const loadEvents = async () => {
                try {
                    // Subscribe to events collection for real-time updates
                    const unsub = db.collection('events').onSnapshot(snapshot => {
                        const eventsList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setEvents(eventsList);
                        setLoading(false);
                    });
                    unsubscribeRefs.current.push(unsub);
                } catch (error) {
                    console.log('Error loading events:', error);
                    setLoading(false);
                }
            };

            const setupRealtimeListeners = (eventId) => {
                // Tables listener
                const unsubTables = db.collection('events').doc(eventId).collection('tables')
                    .onSnapshot(snapshot => {
                        const tablesList = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data(),
                            width: doc.data().width || 80,
                            height: doc.data().height || 80
                        }));
                        setTables(tablesList);
                    });
                unsubscribeRefs.current.push(unsubTables);

                // Bookings listener
                const unsubBookings = db.collection('events').doc(eventId).collection('bookings')
                    .onSnapshot(snapshot => {
                        const bookingsList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setBookings(bookingsList);
                    });
                unsubscribeRefs.current.push(unsubBookings);

                // PRs listener
                const unsubPrs = db.collection('events').doc(eventId).collection('prs')
                    .onSnapshot(snapshot => {
                        const prsList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setPrs(prsList);
                    });
                unsubscribeRefs.current.push(unsubPrs);

                // Guest lists listener
                const unsubGuestLists = db.collection('events').doc(eventId).collection('guestLists')
                    .onSnapshot(snapshot => {
                        const guestListsList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setGuestLists(guestListsList);
                    });
                unsubscribeRefs.current.push(unsubGuestLists);

                // Menu listener
                const unsubMenu = db.collection('events').doc(eventId).collection('menu')
                    .onSnapshot(snapshot => {
                        const menuList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setMenu(menuList);
                    });
                unsubscribeRefs.current.push(unsubMenu);

                // Orders listener
                const unsubOrders = db.collection('events').doc(eventId).collection('orders')
                    .onSnapshot(snapshot => {
                        const ordersList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setOrders(ordersList);
                    });
                unsubscribeRefs.current.push(unsubOrders);

                // Waiter calls listener - only pending from last hour
                const hourAgo = new Date(Date.now() - 60 * 60 * 1000);
                const unsubCalls = db.collection('events').doc(eventId).collection('waiterCalls')
                    .where('status', '==', 'pending')
                    .where('createdAt', '>', hourAgo.toISOString())
                    .onSnapshot(snapshot => {
                        const callsList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setWaiterCalls(callsList);
                    });
                unsubscribeRefs.current.push(unsubCalls);

                // Inventory listener
                const unsubInventory = db.collection('events').doc(eventId).collection('inventory')
                    .onSnapshot(snapshot => {
                        const inventoryList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setInventory(inventoryList);
                    });
                unsubscribeRefs.current.push(unsubInventory);

                // Staff listener
                const unsubStaff = db.collection('events').doc(eventId).collection('staff')
                    .onSnapshot(snapshot => {
                        const staffList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setStaff(staffList);
                    });
                unsubscribeRefs.current.push(unsubStaff);
            };

            // SAVE FUNCTIONS - Firebase versions
            const saveEvents = async (newEvent) => {
                try {
                    if (newEvent.id) {
                        await db.collection('events').doc(newEvent.id).set(newEvent);
                    }
                } catch (error) {
                    console.error('Error saving event:', error);
                }
            };

            const saveTables = async (eventId, newTables) => {
                // Tables are saved individually, this updates the local state
                setTables(newTables);
            };

            const saveTable = async (eventId, table) => {
                try {
                    await db.collection('events').doc(eventId).collection('tables').doc(table.id).set(table);
                } catch (error) {
                    console.error('Error saving table:', error);
                }
            };

            const deleteTable = async (eventId, tableId) => {
                try {
                    await db.collection('events').doc(eventId).collection('tables').doc(tableId).delete();
                } catch (error) {
                    console.error('Error deleting table:', error);
                }
            };

            const saveBookings = async (eventId, newBookings) => {
                setBookings(newBookings);
            };

            const saveBooking = async (eventId, booking) => {
                try {
                    await db.collection('events').doc(eventId).collection('bookings').doc(booking.id).set(booking);
                } catch (error) {
                    console.error('Error saving booking:', error);
                }
            };

            const deleteBooking = async (eventId, bookingId) => {
                try {
                    await db.collection('events').doc(eventId).collection('bookings').doc(bookingId).delete();
                } catch (error) {
                    console.error('Error deleting booking:', error);
                }
            };

            const savePrs = async (eventId, newPrs) => {
                setPrs(newPrs);
            };

            const savePr = async (eventId, pr) => {
                try {
                    await db.collection('events').doc(eventId).collection('prs').doc(pr.id).set(pr);
                } catch (error) {
                    console.error('Error saving PR:', error);
                }
            };

            const deletePr = async (eventId, prId) => {
                try {
                    await db.collection('events').doc(eventId).collection('prs').doc(prId).delete();
                } catch (error) {
                    console.error('Error deleting PR:', error);
                }
            };

            const saveGuestLists = async (eventId, newGuestLists) => {
                setGuestLists(newGuestLists);
            };

            const saveGuest = async (eventId, guest) => {
                try {
                    await db.collection('events').doc(eventId).collection('guestLists').doc(guest.id).set(guest);
                } catch (error) {
                    console.error('Error saving guest:', error);
                }
            };

            const deleteGuest = async (eventId, guestId) => {
                try {
                    await db.collection('events').doc(eventId).collection('guestLists').doc(guestId).delete();
                } catch (error) {
                    console.error('Error deleting guest:', error);
                }
            };

            const saveMenu = async (eventId, newMenu) => {
                setMenu(newMenu);
            };

            const saveMenuItem = async (eventId, item) => {
                try {
                    await db.collection('events').doc(eventId).collection('menu').doc(item.id).set(item);
                } catch (error) {
                    console.error('Error saving menu item:', error);
                }
            };

            const deleteMenuItem = async (eventId, itemId) => {
                try {
                    await db.collection('events').doc(eventId).collection('menu').doc(itemId).delete();
                } catch (error) {
                    console.error('Error deleting menu item:', error);
                }
            };

            const saveOrders = async (eventId, newOrders) => {
                setOrders(newOrders);
            };

            const saveOrder = async (eventId, order) => {
                try {
                    await db.collection('events').doc(eventId).collection('orders').doc(order.id).set(order);
                } catch (error) {
                    console.error('Error saving order:', error);
                }
            };

            const addMenuItem = async (item) => {
                const newItem = {
                    id: Date.now().toString(),
                    ...item,
                    createdAt: new Date().toISOString()
                };
                await saveMenuItem(currentEvent.id, newItem);
            };

            const removeMenuItem = async (itemId) => {
                await deleteMenuItem(currentEvent.id, itemId);
            };

            const getTableOrders = (tableId) => {
                return orders.filter(o => o.tableId === tableId);
            };

            const getTableTotal = (tableId) => {
                return orders
                    .filter(o => o.tableId === tableId)
                    .reduce((sum, o) => sum + o.total, 0);
            };

            const getTotalRevenue = () => {
                return orders.reduce((sum, o) => sum + o.total, 0);
            };

            // ORDER STATUS MANAGEMENT
            const updateOrderStatus = async (orderId, newStatus) => {
                const newOrders = orders.map(o =>
                    o.id === orderId ? { ...o, status: newStatus, updatedAt: new Date().toISOString() } : o
                );
                await saveOrders(currentEvent.id, newOrders);
            };

            const getOrdersByStatus = (status) => {
                if (status === 'all') return orders;
                return orders.filter(o => (o.status || 'pending') === status);
            };

            // INVENTORY-MENU HELPERS
            const getInventoryStock = (productName) => {
                const item = inventory.find(i => i.name.toLowerCase() === productName.toLowerCase());
                if (!item) return null;
                const bottlesUsed = calculateBottlesUsed();
                const usedFromOrders = bottlesUsed[item.name] || 0;
                const totalUsed = usedFromOrders + (item.manualConsumption || 0);
                return item.initialStock - totalUsed;
            };

            const isProductAvailable = (productName) => {
                const stock = getInventoryStock(productName);
                return stock === null || stock > 0;
            };

            // EXPORT CSV FUNCTIONS
            const exportOrdersCSV = () => {
                const headers = ['Tavolo', 'Prodotto', 'Quantità', 'Prezzo Unit.', 'Totale', 'Stato', 'Ora'];
                const rows = orders.map(o => {
                    const table = tables.find(t => t.id === o.tableId);
                    return [
                        table?.number || 'N/A',
                        o.productName,
                        o.quantity,
                        (o.total / o.quantity).toFixed(2),
                        o.total.toFixed(2),
                        o.status || 'pending',
                        new Date(o.createdAt).toLocaleString('it-IT')
                    ];
                });
                downloadCSV([headers, ...rows], `ordini_${currentEvent.name}_${new Date().toISOString().split('T')[0]}.csv`);
            };

            const exportInventoryCSV = () => {
                const headers = ['Prodotto', 'Categoria', 'Prezzo', 'Stock Iniziale', 'Da Ordini', 'Manuale', 'Rimanente'];
                const bottlesUsed = calculateBottlesUsed();
                const rows = inventory.map(i => {
                    const fromOrders = bottlesUsed[i.name] || 0;
                    const remaining = i.initialStock - fromOrders - (i.manualConsumption || 0);
                    return [
                        i.name,
                        i.category,
                        i.unitPrice.toFixed(2),
                        i.initialStock,
                        fromOrders,
                        i.manualConsumption || 0,
                        remaining
                    ];
                });
                downloadCSV([headers, ...rows], `inventario_${currentEvent.name}_${new Date().toISOString().split('T')[0]}.csv`);
            };

            const exportStaffCSV = () => {
                const headers = ['Nome', 'Ruolo', 'Telefono', 'Paga/Ora', 'Check-in', 'Check-out', 'Ore', 'Costo'];
                const rows = staff.map(s => {
                    let hours = 0;
                    if (s.checkInTime) {
                        const checkIn = new Date(s.checkInTime);
                        const checkOut = s.checkOutTime ? new Date(s.checkOutTime) : new Date();
                        hours = (checkOut - checkIn) / (1000 * 60 * 60);
                    }
                    return [
                        s.name,
                        s.role,
                        s.phone || '-',
                        s.hourlyRate || 0,
                        s.checkInTime ? new Date(s.checkInTime).toLocaleTimeString('it-IT') : '-',
                        s.checkOutTime ? new Date(s.checkOutTime).toLocaleTimeString('it-IT') : '-',
                        hours.toFixed(2),
                        (hours * (s.hourlyRate || 0)).toFixed(2)
                    ];
                });
                downloadCSV([headers, ...rows], `staff_${currentEvent.name}_${new Date().toISOString().split('T')[0]}.csv`);
            };

            const exportFullReportCSV = () => {
                const date = new Date().toISOString().split('T')[0];
                const eventName = currentEvent.name;
                
                // Summary section
                const summaryRows = [
                    ['REPORT SERATA'],
                    ['Evento', eventName],
                    ['Data', new Date(currentEvent.date).toLocaleDateString('it-IT')],
                    ['Location', currentEvent.venue],
                    [''],
                    ['RIEPILOGO'],
                    ['Totale Fatturato', `€${getTotalRevenue().toFixed(2)}`],
                    ['Ordini Totali', orders.length],
                    ['Tavoli Prenotati', bookings.length],
                    ['Staff Impiegato', staff.length],
                    [''],
                ];

                // Orders by table
                const orderRows = [['ORDINI PER TAVOLO'], ['Tavolo', 'Ospite', 'Ordini', 'Totale']];
                tables.forEach(t => {
                    const tableOrders = getTableOrders(t.id);
                    const booking = bookings.find(b => b.tableId === t.id);
                    if (tableOrders.length > 0) {
                        orderRows.push([
                            t.number,
                            booking?.guestName || '-',
                            tableOrders.length,
                            `€${getTableTotal(t.id).toFixed(2)}`
                        ]);
                    }
                });
                orderRows.push(['']);

                // Inventory
                const bottlesUsed = calculateBottlesUsed();
                const invRows = [['INVENTARIO'], ['Prodotto', 'Iniziale', 'Consumato', 'Rimanente']];
                inventory.forEach(i => {
                    const fromOrders = bottlesUsed[i.name] || 0;
                    const consumed = fromOrders + (i.manualConsumption || 0);
                    invRows.push([i.name, i.initialStock, consumed, i.initialStock - consumed]);
                });
                invRows.push(['']);

                // Staff
                const staffRows = [['STAFF'], ['Nome', 'Ruolo', 'Ore', 'Costo']];
                staff.forEach(s => {
                    let hours = 0;
                    if (s.checkInTime) {
                        const checkIn = new Date(s.checkInTime);
                        const checkOut = s.checkOutTime ? new Date(s.checkOutTime) : new Date();
                        hours = (checkOut - checkIn) / (1000 * 60 * 60);
                    }
                    staffRows.push([s.name, s.role, hours.toFixed(2), `€${(hours * (s.hourlyRate || 0)).toFixed(2)}`]);
                });

                downloadCSV([...summaryRows, ...orderRows, ...invRows, ...staffRows], `report_completo_${eventName}_${date}.csv`);
            };

            const downloadCSV = (rows, filename) => {
                const csvContent = rows.map(r => r.map(cell => `"${cell}"`).join(',')).join('\n');
                const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.click();
                URL.revokeObjectURL(url);
            };

            const clearWaiterCall = async (callId) => {
                try {
                    await db.collection('events').doc(currentEvent.id).collection('waiterCalls').doc(callId).update({
                        status: 'completed',
                        completedAt: new Date().toISOString()
                    });
                } catch (error) {
                    console.error('Error clearing call:', error);
                }
            };

            // INVENTORY MANAGEMENT
            const saveInventoryItem = async (eventId, item) => {
                try {
                    await db.collection('events').doc(eventId).collection('inventory').doc(item.id).set(item);
                } catch (error) {
                    console.error('Error saving inventory item:', error);
                }
            };

            const addInventoryItem = async (item) => {
                const newItem = {
                    id: Date.now().toString(),
                    ...item,
                    initialStock: item.quantity,
                    currentStock: item.quantity,
                    manualConsumption: 0,
                    createdAt: new Date().toISOString()
                };
                await saveInventoryItem(currentEvent.id, newItem);
            };

            const updateInventoryItem = async (itemId, updates) => {
                try {
                    await db.collection('events').doc(currentEvent.id).collection('inventory').doc(itemId).update(updates);
                } catch (error) {
                    console.error('Error updating inventory:', error);
                }
            };

            const removeInventoryItem = async (itemId) => {
                try {
                    await db.collection('events').doc(currentEvent.id).collection('inventory').doc(itemId).delete();
                } catch (error) {
                    console.error('Error deleting inventory item:', error);
                }
            };

            const calculateBottlesUsed = () => {
                // Calculate bottles used from orders
                const bottleOrders = orders.filter(o => {
                    const product = menu.find(p => p.id === o.productId);
                    return product && product.category === 'Bottiglie';
                });

                const bottlesCount = {};
                bottleOrders.forEach(order => {
                    if (bottlesCount[order.productName]) {
                        bottlesCount[order.productName] += order.quantity;
                    } else {
                        bottlesCount[order.productName] = order.quantity;
                    }
                });

                return bottlesCount;
            };

            const finalizeInventory = async () => {
                const bottlesUsed = calculateBottlesUsed();
                
                // Update each inventory item in Firebase
                for (const item of inventory) {
                    const bottlesFromOrders = bottlesUsed[item.name] || 0;
                    const totalUsed = bottlesFromOrders + (item.manualConsumption || 0);
                    await updateInventoryItem(item.id, {
                        currentStock: item.initialStock - totalUsed,
                        bottlesFromOrders,
                        totalUsed,
                        finalizedAt: new Date().toISOString()
                    });
                }

                alert(`Inventario aggiornato!\n\nBottiglie consumate dai tavoli: ${Object.values(bottlesUsed).reduce((a,b) => a+b, 0)}`);
            };

            // STAFF MANAGEMENT
            const saveStaffMember = async (eventId, member) => {
                try {
                    await db.collection('events').doc(eventId).collection('staff').doc(member.id).set(member);
                } catch (error) {
                    console.error('Error saving staff member:', error);
                }
            };

            const addStaffMember = async (member) => {
                const newMember = {
                    id: Date.now().toString(),
                    ...member,
                    status: 'off-duty',
                    checkInTime: null,
                    checkOutTime: null,
                    createdAt: new Date().toISOString()
                };
                await saveStaffMember(currentEvent.id, newMember);
            };

            const toggleStaffStatus = async (staffId) => {
                const now = new Date().toISOString();
                const member = staff.find(s => s.id === staffId);
                if (!member) return;
                
                const updates = member.status === 'off-duty'
                    ? { status: 'on-duty', checkInTime: now }
                    : { status: 'off-duty', checkOutTime: now };
                
                try {
                    await db.collection('events').doc(currentEvent.id).collection('staff').doc(staffId).update(updates);
                } catch (error) {
                    console.error('Error toggling staff status:', error);
                }
            };

            const removeStaffMember = async (staffId) => {
                try {
                    await db.collection('events').doc(currentEvent.id).collection('staff').doc(staffId).delete();
                } catch (error) {
                    console.error('Error removing staff member:', error);
                }
            };

            const createEvent = async (eventData) => {
                const newEvent = {
                    id: Date.now().toString(),
                    ...eventData,
                    createdAt: new Date().toISOString()
                };
                try {
                    await db.collection('events').doc(newEvent.id).set(newEvent);
                    setShowNewEvent(false);
                    setCurrentEvent(newEvent);
                } catch (error) {
                    console.error('Error creating event:', error);
                }
            };

            const deleteEvent = async (eventId) => {
                if (!confirm('Sei sicura di voler eliminare questa serata?')) return;
                
                try {
                    // Delete all subcollections first
                    const subcollections = ['tables', 'bookings', 'prs', 'guestLists', 'menu', 'orders', 'waiterCalls', 'inventory', 'staff'];
                    for (const sub of subcollections) {
                        const snapshot = await db.collection('events').doc(eventId).collection(sub).get();
                        const batch = db.batch();
                        snapshot.docs.forEach(doc => batch.delete(doc.ref));
                        await batch.commit();
                    }
                    // Delete the event document
                    await db.collection('events').doc(eventId).delete();
                    
                    if (currentEvent?.id === eventId) {
                        setCurrentEvent(null);
                    }
                } catch (error) {
                    console.error('Error deleting event:', error);
                }
            };

            const addTable = async () => {
                const newTable = {
                    id: Date.now().toString(),
                    number: tables.length + 1,
                    x: 100,
                    y: 100,
                    width: 80,
                    height: 80,
                    capacity: 8,
                    shape: 'round'
                };
                await saveTable(currentEvent.id, newTable);
            };

            const removeTable = async (tableId) => {
                await deleteTable(currentEvent.id, tableId);
                // Also delete associated bookings
                const tableBookings = bookings.filter(b => b.tableId === tableId);
                for (const booking of tableBookings) {
                    await deleteBooking(currentEvent.id, booking.id);
                }
            };

            const updateTable = async (tableId, updates) => {
                const table = tables.find(t => t.id === tableId);
                if (table) {
                    await saveTable(currentEvent.id, { ...table, ...updates });
                }
            };

            const handleTableDragStart = (e, table) => {
                setDraggedTable(table);
                e.dataTransfer.effectAllowed = 'move';
            };

            const handleResizeStart = (e, table, corner) => {
                e.stopPropagation();
                e.preventDefault();
                setResizingTable({ table, corner });
                setResizeStart({ 
                    x: e.clientX, 
                    y: e.clientY, 
                    width: table.width || 80, 
                    height: table.height || 80,
                    tableX: table.x,
                    tableY: table.y
                });
            };

            const handleResizeMove = (e) => {
                if (!resizingTable || !resizeStart) return;
                
                const deltaX = e.clientX - resizeStart.x;
                const deltaY = e.clientY - resizeStart.y;
                const { table, corner } = resizingTable;
                
                let newWidth = resizeStart.width;
                let newHeight = resizeStart.height;
                let newX = resizeStart.tableX;
                let newY = resizeStart.tableY;
                
                switch(corner) {
                    case 'se': // Bottom-right
                        newWidth = Math.max(40, resizeStart.width + deltaX);
                        newHeight = Math.max(40, resizeStart.height + deltaY);
                        break;
                    case 'sw': // Bottom-left
                        newWidth = Math.max(40, resizeStart.width - deltaX);
                        newHeight = Math.max(40, resizeStart.height + deltaY);
                        newX = resizeStart.tableX + (resizeStart.width - newWidth);
                        break;
                    case 'ne': // Top-right
                        newWidth = Math.max(40, resizeStart.width + deltaX);
                        newHeight = Math.max(40, resizeStart.height - deltaY);
                        newY = resizeStart.tableY + (resizeStart.height - newHeight);
                        break;
                    case 'nw': // Top-left
                        newWidth = Math.max(40, resizeStart.width - deltaX);
                        newHeight = Math.max(40, resizeStart.height - deltaY);
                        newX = resizeStart.tableX + (resizeStart.width - newWidth);
                        newY = resizeStart.tableY + (resizeStart.height - newHeight);
                        break;
                }
                
                updateTable(table.id, { 
                    width: newWidth, 
                    height: newHeight,
                    x: newX,
                    y: newY
                });
            };

            const handleResizeEnd = () => {
                setResizingTable(null);
                setResizeStart(null);
            };

            useEffect(() => {
                if (resizingTable) {
                    document.addEventListener('mousemove', handleResizeMove);
                    document.addEventListener('mouseup', handleResizeEnd);
                    return () => {
                        document.removeEventListener('mousemove', handleResizeMove);
                        document.removeEventListener('mouseup', handleResizeEnd);
                    };
                }
            }, [resizingTable, resizeStart]);

            const handleFloorPlanDrop = (e) => {
                e.preventDefault();
                if (!draggedTable || !editMode) return;

                const rect = floorPlanRef.current.getBoundingClientRect();
                const x = e.clientX - rect.left - 40;
                const y = e.clientY - rect.top - 40;

                updateTable(draggedTable.id, { x: Math.max(0, x), y: Math.max(0, y) });
                setDraggedTable(null);
            };

            const addBooking = async (bookingData) => {
                const newBooking = {
                    id: Date.now().toString(),
                    tableId: selectedTable.id,
                    ...bookingData,
                    status: 'confirmed',
                    createdAt: new Date().toISOString()
                };
                await saveBooking(currentEvent.id, newBooking);
                setSelectedTable(null);
            };

            const removeBookingById = async (bookingId) => {
                await deleteBooking(currentEvent.id, bookingId);
            };

            const addPr = async (prData) => {
                const newPr = {
                    id: Date.now().toString(),
                    ...prData,
                    createdAt: new Date().toISOString()
                };
                await savePr(currentEvent.id, newPr);
                setShowNewPr(false);
            };

            const removePr = async (prId) => {
                if (!confirm('Eliminare questo PR? Verranno rimosse anche le sue liste.')) return;
                
                // Delete PR
                await deletePr(currentEvent.id, prId);
                
                // Delete associated guests
                const prGuests = guestLists.filter(g => g.prId === prId);
                for (const guest of prGuests) {
                    await deleteGuest(currentEvent.id, guest.id);
                }
                
                // Update associated bookings to remove PR reference
                const prBookings = bookings.filter(b => b.prId === prId);
                for (const booking of prBookings) {
                    await saveBooking(currentEvent.id, { ...booking, prId: null, prName: null });
                }
            };

            const addGuestToList = async (prId, guestData) => {
                const newGuest = {
                    id: Date.now().toString(),
                    prId,
                    ...guestData,
                    checkedIn: false,
                    createdAt: new Date().toISOString()
                };
                await saveGuest(currentEvent.id, newGuest);
            };

            const importGuestsBatch = async (prId, guestsText) => {
                const lines = guestsText.split('\n').filter(line => line.trim());
                let importedCount = 0;
                
                for (const line of lines) {
                    const trimmedLine = line.trim();
                    if (!trimmedLine) continue;
                    
                    let guestName = trimmedLine;
                    let guestCount = 1;
                    
                    const dashMatch = trimmedLine.match(/^(.+?)\s*-\s*(\d+)$/);
                    if (dashMatch) {
                        guestName = dashMatch[1].trim();
                        guestCount = parseInt(dashMatch[2]);
                    } else {
                        const parenMatch = trimmedLine.match(/^(.+?)\s*\((\d+)\)$/);
                        if (parenMatch) {
                            guestName = parenMatch[1].trim();
                            guestCount = parseInt(parenMatch[2]);
                        }
                    }
                    
                    if (guestName) {
                        const newGuest = {
                            id: `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                            prId,
                            guestName,
                            guestCount,
                            checkedIn: false,
                            createdAt: new Date().toISOString()
                        };
                        await saveGuest(currentEvent.id, newGuest);
                        importedCount++;
                    }
                }
                
                return importedCount;
            };

            const toggleGuestCheckIn = async (guestId) => {
                const guest = guestLists.find(g => g.id === guestId);
                if (guest) {
                    await saveGuest(currentEvent.id, { ...guest, checkedIn: !guest.checkedIn });
                }
            };

            const removeGuestFromList = async (guestId) => {
                await deleteGuest(currentEvent.id, guestId);
            };

            const getPrStats = (prId) => {
                const prGuestLists = guestLists.filter(g => g.prId === prId);
                const prBookings = bookings.filter(b => b.prId === prId);
                const checkedInGuests = prGuestLists.filter(g => g.checkedIn).length;
                const totalGuestsInList = prGuestLists.reduce((sum, g) => sum + (g.guestCount || 1), 0);
                const totalGuestsInTables = prBookings.reduce((sum, b) => sum + (b.guestCount || 0), 0);
                
                return {
                    totalGuests: totalGuestsInList + totalGuestsInTables,
                    guestListCount: totalGuestsInList,
                    checkedInCount: checkedInGuests,
                    tableBookings: prBookings.length,
                    tableGuests: totalGuestsInTables
                };
            };

            const getTableBooking = (tableId) => {
                return bookings.find(b => b.tableId === tableId);
            };

            const getTableStatus = (table) => {
                const booking = getTableBooking(table.id);
                if (!booking) return 'available';
                if (booking.status === 'arrived') return 'occupied';
                return 'reserved';
            };

            if (loading) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex items-center justify-center">
                        <div className="text-white text-2xl font-light">Caricamento...</div>
                    </div>
                );
            }

            if (!currentEvent) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-8">
                        <div className="max-w-6xl mx-auto">
                            <header className="mb-12 text-center">
                                <h1 className="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-400 via-purple-400 to-cyan-400 mb-4 tracking-tight">
                                    @_muse.in_
                                </h1>
                                <p className="text-purple-300 text-lg font-light">Gestione Tavoli Eventi</p>
                            </header>

                            <div className="mb-8 flex justify-between items-center">
                                <h2 className="text-3xl font-bold text-white">Le tue serate</h2>
                                <button
                                    onClick={() => setShowNewEvent(true)}
                                    className="bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700 text-white px-6 py-3 rounded-lg flex items-center gap-2 transition-all transform hover:scale-105 shadow-lg shadow-purple-500/50"
                                >
                                    <Plus size={20} />
                                    Nuova Serata
                                </button>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {events.map(event => (
                                    <div
                                        key={event.id}
                                        className="bg-slate-800/50 backdrop-blur-sm border border-purple-500/30 rounded-xl p-6 hover:border-purple-400/60 transition-all cursor-pointer group relative overflow-hidden"
                                        onClick={() => setCurrentEvent(event)}
                                    >
                                        <div className="absolute inset-0 bg-gradient-to-br from-purple-600/10 to-pink-600/10 opacity-0 group-hover:opacity-100 transition-opacity" />
                                        
                                        <div className="relative z-10">
                                            <h3 className="text-2xl font-bold text-white mb-4 group-hover:text-purple-300 transition-colors">
                                                {event.name}
                                            </h3>
                                            
                                            <div className="space-y-2 text-purple-300">
                                                <div className="flex items-center gap-2">
                                                    <Calendar size={16} />
                                                    <span className="text-sm">{new Date(event.date).toLocaleDateString('it-IT')}</span>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <MapPin size={16} />
                                                    <span className="text-sm">{event.venue}</span>
                                                </div>
                                            </div>

                                            <button
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    deleteEvent(event.id);
                                                }}
                                                className="absolute top-4 right-4 text-red-400 hover:text-red-300 opacity-0 group-hover:opacity-100 transition-opacity"
                                            >
                                                <Trash2 size={18} />
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            {events.length === 0 && (
                                <div className="text-center py-20 text-purple-300">
                                    <Users size={64} className="mx-auto mb-4 opacity-50" />
                                    <p className="text-xl">Nessuna serata creata. Inizia creando il tuo primo evento!</p>
                                </div>
                            )}
                        </div>

                        {showNewEvent && <NewEventModal onClose={() => setShowNewEvent(false)} onCreate={createEvent} />}
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-8">
                    <div className="max-w-7xl mx-auto">
                        <header className="mb-8 flex justify-between items-center">
                            <div className="flex items-center gap-4">
                                <button
                                    onClick={() => setCurrentEvent(null)}
                                    className="text-purple-300 hover:text-white transition-colors"
                                >
                                    <ChevronLeft size={32} />
                                </button>
                                <div>
                                    <h1 className="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-cyan-400">
                                        {currentEvent.name}
                                    </h1>
                                    <p className="text-purple-300">
                                        {new Date(currentEvent.date).toLocaleDateString('it-IT')} • {currentEvent.venue}
                                    </p>
                                </div>
                            </div>
                            <div className="flex gap-2 flex-wrap">
                                <button
                                    onClick={() => {
                                        setShowPrView(false);
                                        setShowOrdersView(false);
                                        setShowInventoryView(false);
                                        setShowStaffView(false);
                                    }}
                                    className={`${!showPrView && !showOrdersView && !showInventoryView && !showStaffView ? 'bg-purple-600' : 'bg-slate-700'} hover:bg-purple-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-all text-sm`}
                                >
                                    <MapPin size={18} />
                                    Tavoli
                                </button>
                                <button
                                    onClick={() => {
                                        setShowPrView(true);
                                        setShowOrdersView(false);
                                        setShowInventoryView(false);
                                        setShowStaffView(false);
                                    }}
                                    className={`${showPrView ? 'bg-cyan-600' : 'bg-slate-700'} hover:bg-cyan-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-all text-sm`}
                                >
                                    <Users size={18} />
                                    Liste PR
                                </button>
                                <button
                                    onClick={() => {
                                        setShowPrView(false);
                                        setShowOrdersView(true);
                                        setShowInventoryView(false);
                                        setShowStaffView(false);
                                    }}
                                    className={`${showOrdersView ? 'bg-pink-600' : 'bg-slate-700'} hover:bg-pink-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-all text-sm`}
                                >
                                    🍾
                                    Ordini
                                </button>
                                <button
                                    onClick={() => {
                                        setShowPrView(false);
                                        setShowOrdersView(false);
                                        setShowInventoryView(true);
                                        setShowStaffView(false);
                                    }}
                                    className={`${showInventoryView ? 'bg-amber-600' : 'bg-slate-700'} hover:bg-amber-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-all text-sm`}
                                >
                                    <Package size={18} />
                                    Magazzino
                                </button>
                                <button
                                    onClick={() => {
                                        setShowPrView(false);
                                        setShowOrdersView(false);
                                        setShowInventoryView(false);
                                        setShowStaffView(true);
                                    }}
                                    className={`${showStaffView ? 'bg-emerald-600' : 'bg-slate-700'} hover:bg-emerald-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-all text-sm`}
                                >
                                    <UserCheck size={18} />
                                    Staff
                                </button>
                                {!showPrView && !showOrdersView && !showInventoryView && !showStaffView && (editMode ? (
                                    <button
                                        onClick={() => setEditMode(false)}
                                        className="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg flex items-center gap-2 transition-all"
                                    >
                                        <Save size={20} />
                                        Salva Layout
                                    </button>
                                ) : (
                                    <button
                                        onClick={() => setEditMode(true)}
                                        className="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg flex items-center gap-2 transition-all"
                                    >
                                        <Edit3 size={20} />
                                        Modifica Layout
                                    </button>
                                ))}
                                {editMode && !showPrView && !showOrdersView && !showInventoryView && !showStaffView && (
                                    <button
                                        onClick={addTable}
                                        className="bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700 text-white px-6 py-3 rounded-lg flex items-center gap-2 transition-all"
                                    >
                                        <Plus size={20} />
                                        Aggiungi Tavolo
                                    </button>
                                )}
                            </div>
                        </header>

                        <div className="grid grid-cols-5 gap-6 mb-8">
                            <StatCard 
                                label="Tavoli Totali" 
                                value={tables.length} 
                                color="from-purple-500 to-pink-500"
                            />
                            <StatCard 
                                label="Prenotazioni" 
                                value={bookings.length} 
                                color="from-cyan-500 to-blue-500"
                            />
                            <StatCard 
                                label="PR Attivi" 
                                value={prs.length} 
                                color="from-pink-500 to-orange-500"
                            />
                            <StatCard 
                                label="Totale Ospiti" 
                                value={bookings.reduce((sum, b) => sum + (b.guestCount || 0), 0) + guestLists.reduce((sum, g) => sum + (g.guestCount || 1), 0)} 
                                color="from-green-500 to-emerald-500"
                            />
                            <StatCard 
                                label="Fatturato" 
                                value={`€${getTotalRevenue()}`} 
                                color="from-yellow-500 to-orange-500"
                            />
                        </div>

                        {showOrdersView ? (
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                {/* Menu Editor & Orders List */}
                                <div className="lg:col-span-2">
                                    <div className="bg-slate-800/50 backdrop-blur-sm border border-purple-500/30 rounded-xl p-6 mb-6">
                                        <div className="flex justify-between items-center mb-4">
                                            <h2 className="text-2xl font-bold text-white">Menu</h2>
                                            <button
                                                onClick={() => {
                                                    const name = prompt('Nome prodotto:');
                                                    if (!name) return;
                                                    const category = prompt('Categoria (es: Bottiglie, Drink, Cocktail):');
                                                    if (!category) return;
                                                    const price = parseFloat(prompt('Prezzo €:'));
                                                    if (isNaN(price)) return;
                                                    addMenuItem({ name, category, price });
                                                }}
                                                className="bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-all text-sm"
                                            >
                                                <Plus size={16} />
                                                Aggiungi Prodotto
                                            </button>
                                        </div>
                                        <div className="space-y-2 max-h-[300px] overflow-y-auto">
                                            {menu.map(item => (
                                                <div key={item.id} className="flex justify-between items-center bg-slate-900/50 p-3 rounded-lg">
                                                    <div>
                                                        <span className="text-white font-bold">{item.name}</span>
                                                        <span className="text-purple-300 text-sm ml-2">({item.category})</span>
                                                    </div>
                                                    <div className="flex items-center gap-3">
                                                        <span className="text-green-400 font-bold">€{item.price.toFixed(2)}</span>
                                                        <button
                                                            onClick={() => removeMenuItem(item.id)}
                                                            className="text-red-400 hover:text-red-300"
                                                        >
                                                            <X size={16} />
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                            {menu.length === 0 && (
                                                <div className="text-center py-8 text-purple-300">
                                                    <p>Nessun prodotto nel menu</p>
                                                    <p className="text-sm mt-2">Aggiungi prodotti per abilitare gli ordini</p>
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    <div className="bg-slate-800/50 backdrop-blur-sm border border-purple-500/30 rounded-xl p-6 mb-6">
                                        <h2 className="text-2xl font-bold text-white mb-4">
                                            🔔 Chiamate Cameriere {waiterCalls.length > 0 && `(${waiterCalls.length})`}
                                        </h2>
                                        <div className="space-y-2 max-h-[200px] overflow-y-auto">
                                            {waiterCalls.map(call => (
                                                <div
                                                    key={call.id}
                                                    className="bg-orange-500/20 border border-orange-400/50 rounded-lg p-4 flex justify-between items-center animate-pulse"
                                                >
                                                    <div>
                                                        <div className="text-white font-bold text-lg">Tavolo {call.tableNumber}</div>
                                                        <div className="text-orange-300 text-sm">
                                                            {new Date(call.createdAt).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' })}
                                                        </div>
                                                    </div>
                                                    <button
                                                        onClick={() => clearWaiterCall(call.id)}
                                                        className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-bold"
                                                    >
                                                        ✓ Servito
                                                    </button>
                                                </div>
                                            ))}
                                            {waiterCalls.length === 0 && (
                                                <div className="text-center py-6 text-purple-300">
                                                    <p className="text-sm">Nessuna chiamata in attesa</p>
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    <div className="bg-slate-800/50 backdrop-blur-sm border border-purple-500/30 rounded-xl p-6">
                                        <h2 className="text-2xl font-bold text-white mb-4">Tutti gli Ordini</h2>
                                        <div className="space-y-3 max-h-[300px] overflow-y-auto">
                                            {tables.map(table => {
                                                const tableOrders = getTableOrders(table.id);
                                                const tableTotal = getTableTotal(table.id);
                                                if (tableOrders.length === 0) return null;
                                                
                                                return (
                                                    <div key={table.id} className="bg-slate-900/50 rounded-lg p-4 border border-purple-500/20">
                                                        <div className="flex justify-between items-start mb-2">
                                                            <div>
                                                                <h3 className="text-white font-bold">Tavolo {table.number}</h3>
                                                                <p className="text-purple-300 text-sm">{tableOrders.length} ordini</p>
                                                            </div>
                                                            <div className="text-right">
                                                                <div className="text-yellow-400 font-bold text-lg">€{tableTotal.toFixed(2)}</div>
                                                            </div>
                                                        </div>
                                                        <div className="space-y-1 text-sm text-purple-200">
                                                            {tableOrders.map(order => (
                                                                <div key={order.id} className="flex justify-between">
                                                                    <span>{order.quantity}x {order.productName}</span>
                                                                    <span>€{order.total.toFixed(2)}</span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                            {orders.length === 0 && (
                                                <div className="text-center py-12 text-purple-300">
                                                    <p>Nessun ordine ancora</p>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                {/* Table Links */}
                                <div>
                                    <div className="bg-slate-800/50 backdrop-blur-sm border border-purple-500/30 rounded-xl p-6">
                                        <h2 className="text-2xl font-bold text-white mb-4">Link Ordini Tavoli</h2>
                                        <p className="text-purple-300 text-sm mb-4">Genera link QR per ogni tavolo</p>
                                        <div className="space-y-2 max-h-[600px] overflow-y-auto">
                                            {tables.map(table => {
                                                const tableTotal = getTableTotal(table.id);
                                                const booking = getTableBooking(table.id);
                                                
                                                return (
                                                    <div key={table.id} className="bg-slate-900/50 rounded-lg p-3 border border-purple-500/20">
                                                        <div className="flex justify-between items-center mb-2">
                                                            <div>
                                                                <h3 className="text-white font-bold">Tavolo {table.number}</h3>
                                                                {booking && <p className="text-purple-300 text-xs">{booking.guestName}</p>}
                                                            </div>
                                                            <button
                                                                onClick={() => {
                                                                    const baseUrl = window.location.origin + window.location.pathname.replace(/gestione-tavoli\.html.*$/, '');
                                                                    const link = `${baseUrl}client-orders.html?event=${currentEvent.id}&table=${table.id}`;
                                                                    navigator.clipboard.writeText(link);
                                                                    alert(`Link copiato!\n\n${link}\n\nInvialo ai clienti o genera QR code.`);
                                                                }}
                                                                className="text-cyan-400 hover:text-cyan-300 text-sm bg-cyan-500/10 px-3 py-1 rounded font-medium"
                                                            >
                                                                🔗 Link
                                                            </button>
                                                        </div>
                                                        {tableTotal > 0 && (
                                                            <div className="text-yellow-400 font-bold text-sm">
                                                                Totale: €{tableTotal.toFixed(2)}
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ) : showInventoryView ? (
                            /* INVENTORY VIEW */
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <div className="lg:col-span-2">
                                    <div className="bg-slate-800/50 backdrop-blur-sm border border-purple-500/30 rounded-xl p-6 mb-6">
                                        <div className="flex justify-between items-center mb-4">
                                            <h2 className="text-2xl font-bold text-white flex items-center gap-2">
                                                <Package size={24} />
                                                Magazzino Serata
                                            </h2>
                                            <button
                                                onClick={() => {
                                                    const name = prompt('Nome prodotto (es: Vodka Belvedere):');
                                                    if (!name) return;
                                                    const category = prompt('Categoria (es: Vodka, Champagne, Gin):');
                                                    if (!category) return;
                                                    const quantity = parseInt(prompt('Quantità iniziale:'));
                                                    if (isNaN(quantity)) return;
                                                    const unitPrice = parseFloat(prompt('Prezzo unitario €:'));
                                                    if (isNaN(unitPrice)) return;
                                                    addInventoryItem({ name, category, quantity, unitPrice });
                                                }}
                                                className="bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-all text-sm"
                                            >
                                                <Plus size={16} />
                                                Aggiungi Prodotto
                                            </button>
                                        </div>

                                        {/* Inventory Stats */}
                                        <div className="grid grid-cols-3 gap-4 mb-6">
                                            <div className="bg-amber-500/20 rounded-lg p-4 text-center">
                                                <div className="text-amber-200 text-sm">Prodotti</div>
                                                <div className="text-white font-bold text-2xl">{inventory.length}</div>
                                            </div>
                                            <div className="bg-green-500/20 rounded-lg p-4 text-center">
                                                <div className="text-green-200 text-sm">Valore Stock</div>
                                                <div className="text-white font-bold text-2xl">
                                                    €{inventory.reduce((sum, i) => sum + (i.currentStock * i.unitPrice), 0).toFixed(0)}
                                                </div>
                                            </div>
                                            <div className="bg-red-500/20 rounded-lg p-4 text-center">
                                                <div className="text-red-200 text-sm">Sotto Scorta</div>
                                                <div className="text-white font-bold text-2xl">
                                                    {inventory.filter(i => i.currentStock <= 2).length}
                                                </div>
                                            </div>
                                        </div>

                                        {/* Inventory List */}
                                        <div className="space-y-3 max-h-[450px] overflow-y-auto">
                                            {inventory.map(item => {
                                                const bottlesUsed = calculateBottlesUsed();
                                                const usedFromOrders = bottlesUsed[item.name] || 0;
                                                const totalUsed = usedFromOrders + (item.manualConsumption || 0);
                                                const remaining = item.initialStock - totalUsed;
                                                const isLow = remaining <= 2;
                                                
                                                return (
                                                    <div
                                                        key={item.id}
                                                        className={`rounded-lg p-4 border transition-all ${
                                                            isLow 
                                                                ? 'bg-red-500/10 border-red-400/40' 
                                                                : 'bg-slate-900/50 border-purple-500/20'
                                                        }`}
                                                    >
                                                        <div className="flex justify-between items-start mb-3">
                                                            <div>
                                                                <h3 className="text-white font-bold text-lg flex items-center gap-2">
                                                                    {item.name}
                                                                    {isLow && <AlertTriangle size={16} className="text-red-400" />}
                                                                </h3>
                                                                <p className="text-purple-300 text-sm">{item.category} • €{item.unitPrice}/pz</p>
                                                            </div>
                                                            <button
                                                                onClick={() => removeInventoryItem(item.id)}
                                                                className="text-red-400 hover:text-red-300"
                                                            >
                                                                <Trash2 size={16} />
                                                            </button>
                                                        </div>
                                                        
                                                        <div className="grid grid-cols-4 gap-2 mb-3">
                                                            <div className="bg-slate-800/50 rounded p-2 text-center">
                                                                <div className="text-purple-300 text-xs">Iniziale</div>
                                                                <div className="text-white font-bold">{item.initialStock}</div>
                                                            </div>
                                                            <div className="bg-pink-500/20 rounded p-2 text-center">
                                                                <div className="text-pink-300 text-xs">Ordini</div>
                                                                <div className="text-white font-bold">{usedFromOrders}</div>
                                                            </div>
                                                            <div className="bg-orange-500/20 rounded p-2 text-center">
                                                                <div className="text-orange-300 text-xs">Manuale</div>
                                                                <div className="text-white font-bold">{item.manualConsumption || 0}</div>
                                                            </div>
                                                            <div className={`rounded p-2 text-center ${isLow ? 'bg-red-500/30' : 'bg-green-500/20'}`}>
                                                                <div className={`text-xs ${isLow ? 'text-red-300' : 'text-green-300'}`}>Rimaste</div>
                                                                <div className="text-white font-bold">{remaining}</div>
                                                            </div>
                                                        </div>

                                                        {/* Manual consumption controls */}
                                                        <div className="flex items-center justify-between bg-slate-800/30 rounded-lg p-2">
                                                            <span className="text-purple-300 text-sm">Consumo manuale:</span>
                                                            <div className="flex items-center gap-2">
                                                                <button
                                                                    onClick={() => updateInventoryItem(item.id, { 
                                                                        manualConsumption: Math.max(0, (item.manualConsumption || 0) - 1) 
                                                                    })}
                                                                    className="bg-slate-700 hover:bg-slate-600 text-white w-8 h-8 rounded flex items-center justify-center"
                                                                >
                                                                    <Minus size={14} />
                                                                </button>
                                                                <span className="text-white font-bold w-8 text-center">{item.manualConsumption || 0}</span>
                                                                <button
                                                                    onClick={() => updateInventoryItem(item.id, { 
                                                                        manualConsumption: (item.manualConsumption || 0) + 1 
                                                                    })}
                                                                    className="bg-slate-700 hover:bg-slate-600 text-white w-8 h-8 rounded flex items-center justify-center"
                                                                >
                                                                    <Plus size={14} />
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                            {inventory.length === 0 && (
                                                <div className="text-center py-20 text-purple-300">
                                                    <Package size={48} className="mx-auto mb-4 opacity-50" />
                                                    <p>Nessun prodotto in magazzino</p>
                                                    <p className="text-sm mt-2">Aggiungi prodotti per iniziare a tracciare</p>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                {/* Inventory Summary */}
                                <div>
                                    <div className="bg-slate-800/50 backdrop-blur-sm border border-purple-500/30 rounded-xl p-6 mb-6">
                                        <h2 className="text-xl font-bold text-white mb-4">Riepilogo per Categoria</h2>
                                        <div className="space-y-3">
                                            {[...new Set(inventory.map(i => i.category))].map(cat => {
                                                const items = inventory.filter(i => i.category === cat);
                                                const totalInitial = items.reduce((s, i) => s + i.initialStock, 0);
                                                const bottlesUsed = calculateBottlesUsed();
                                                const totalUsed = items.reduce((s, i) => {
                                                    const fromOrders = bottlesUsed[i.name] || 0;
                                                    return s + fromOrders + (i.manualConsumption || 0);
                                                }, 0);
                                                
                                                return (
                                                    <div key={cat} className="bg-slate-900/50 rounded-lg p-3">
                                                        <div className="flex justify-between items-center">
                                                            <span className="text-white font-medium">{cat}</span>
                                                            <span className="text-purple-300">
                                                                {totalInitial - totalUsed}/{totalInitial}
                                                            </span>
                                                        </div>
                                                        <div className="mt-2 bg-slate-700 rounded-full h-2 overflow-hidden">
                                                            <div 
                                                                className="bg-gradient-to-r from-amber-500 to-orange-500 h-full transition-all"
                                                                style={{ width: `${((totalInitial - totalUsed) / totalInitial) * 100}%` }}
                                                            />
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>

                                    <div className="bg-slate-800/50 backdrop-blur-sm border border-purple-500/30 rounded-xl p-6">
                                        <h2 className="text-xl font-bold text-white mb-4">Fine Serata</h2>
                                        <p className="text-purple-300 text-sm mb-4">
                                            Chiudi l'inventario per calcolare il consumo totale e aggiornare le giacenze.
                                        </p>
                                        <button
                                            onClick={finalizeInventory}
                                            className="w-full bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 text-white py-3 rounded-lg font-bold transition-all"
                                        >
                                            Chiudi Inventario Serata
                                        </button>
                                    </div>
                                </div>
                            </div>
                        ) : showStaffView ? (
                            /* STAFF VIEW */
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <div className="lg:col-span-2">
                                    <div className="bg-slate-800/50 backdrop-blur-sm border border-purple-500/30 rounded-xl p-6">
                                        <div className="flex justify-between items-center mb-4">
                                            <h2 className="text-2xl font-bold text-white flex items-center gap-2">
                                                <UserCheck size={24} />
                                                Staff Serata
                                            </h2>
                                            <button
                                                onClick={() => {
                                                    const name = prompt('Nome:');
                                                    if (!name) return;
                                                    const role = prompt('Ruolo (es: Cameriere, Barista, Security, DJ):');
                                                    if (!role) return;
                                                    const phone = prompt('Telefono (opzionale):') || '';
                                                    const hourlyRate = parseFloat(prompt('Paga oraria € (opzionale):') || '0');
                                                    addStaffMember({ name, role, phone, hourlyRate });
                                                }}
                                                className="bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-600 hover:to-green-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-all text-sm"
                                            >
                                                <Plus size={16} />
                                                Aggiungi Staff
                                            </button>
                                        </div>

                                        {/* Staff Stats */}
                                        <div className="grid grid-cols-3 gap-4 mb-6">
                                            <div className="bg-emerald-500/20 rounded-lg p-4 text-center">
                                                <div className="text-emerald-200 text-sm">Totale Staff</div>
                                                <div className="text-white font-bold text-2xl">{staff.length}</div>
                                            </div>
                                            <div className="bg-green-500/20 rounded-lg p-4 text-center">
                                                <div className="text-green-200 text-sm">In Servizio</div>
                                                <div className="text-white font-bold text-2xl">
                                                    {staff.filter(s => s.status === 'on-duty').length}
                                                </div>
                                            </div>
                                            <div className="bg-slate-500/20 rounded-lg p-4 text-center">
                                                <div className="text-slate-300 text-sm">Fuori Servizio</div>
                                                <div className="text-white font-bold text-2xl">
                                                    {staff.filter(s => s.status === 'off-duty').length}
                                                </div>
                                            </div>
                                        </div>

                                        {/* Staff List */}
                                        <div className="space-y-3 max-h-[500px] overflow-y-auto">
                                            {staff.map(member => {
                                                const isOnDuty = member.status === 'on-duty';
                                                let hoursWorked = 0;
                                                if (member.checkInTime) {
                                                    const checkIn = new Date(member.checkInTime);
                                                    const checkOut = member.checkOutTime ? new Date(member.checkOutTime) : new Date();
                                                    hoursWorked = (checkOut - checkIn) / (1000 * 60 * 60);
                                                }

                                                return (
                                                    <div
                                                        key={member.id}
                                                        className={`rounded-lg p-4 border transition-all ${
                                                            isOnDuty 
                                                                ? 'bg-green-500/10 border-green-400/40' 
                                                                : 'bg-slate-900/50 border-purple-500/20'
                                                        }`}
                                                    >
                                                        <div className="flex justify-between items-start mb-3">
                                                            <div className="flex items-start gap-3">
                                                                <div className={`w-3 h-3 rounded-full mt-2 ${isOnDuty ? 'bg-green-400 animate-pulse' : 'bg-slate-500'}`} />
                                                                <div>
                                                                    <h3 className="text-white font-bold text-lg">{member.name}</h3>
                                                                    <p className="text-purple-300 text-sm">{member.role}</p>
                                                                    {member.phone && (
                                                                        <p className="text-purple-400 text-xs flex items-center gap-1 mt-1">
                                                                            <Phone size={12} />
                                                                            {member.phone}
                                                                        </p>
                                                                    )}
                                                                </div>
                                                            </div>
                                                            <button
                                                                onClick={() => removeStaffMember(member.id)}
                                                                className="text-red-400 hover:text-red-300"
                                                            >
                                                                <Trash2 size={16} />
                                                            </button>
                                                        </div>

                                                        <div className="grid grid-cols-3 gap-2 mb-3">
                                                            <div className="bg-slate-800/50 rounded p-2 text-center">
                                                                <div className="text-purple-300 text-xs flex items-center justify-center gap-1">
                                                                    <Clock size={12} />
                                                                    Check-in
                                                                </div>
                                                                <div className="text-white font-medium text-sm">
                                                                    {member.checkInTime 
                                                                        ? new Date(member.checkInTime).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' })
                                                                        : '-'
                                                                    }
                                                                </div>
                                                            </div>
                                                            <div className="bg-slate-800/50 rounded p-2 text-center">
                                                                <div className="text-purple-300 text-xs flex items-center justify-center gap-1">
                                                                    <Clock size={12} />
                                                                    Check-out
                                                                </div>
                                                                <div className="text-white font-medium text-sm">
                                                                    {member.checkOutTime 
                                                                        ? new Date(member.checkOutTime).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' })
                                                                        : isOnDuty ? 'In corso' : '-'
                                                                    }
                                                                </div>
                                                            </div>
                                                            <div className="bg-slate-800/50 rounded p-2 text-center">
                                                                <div className="text-purple-300 text-xs">Ore</div>
                                                                <div className="text-white font-medium text-sm">
                                                                    {hoursWorked > 0 ? hoursWorked.toFixed(1) + 'h' : '-'}
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <button
                                                            onClick={() => toggleStaffStatus(member.id)}
                                                            className={`w-full py-2 rounded-lg font-bold transition-all ${
                                                                isOnDuty
                                                                    ? 'bg-red-500/20 hover:bg-red-500/30 text-red-300 border border-red-500/30'
                                                                    : 'bg-green-500/20 hover:bg-green-500/30 text-green-300 border border-green-500/30'
                                                            }`}
                                                        >
                                                            {isOnDuty ? '⏹ Check-out' : '▶ Check-in'}
                                                        </button>
                                                    </div>
                                                );
                                            })}
                                            {staff.length === 0 && (
                                                <div className="text-center py-20 text-purple-300">
                                                    <UserCheck size={48} className="mx-auto mb-4 opacity-50" />
                                                    <p>Nessuno staff aggiunto</p>
                                                    <p className="text-sm mt-2">Aggiungi il personale per la serata</p>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                {/* Staff Summary */}
                                <div>
                                    <div className="bg-slate-800/50 backdrop-blur-sm border border-purple-500/30 rounded-xl p-6 mb-6">
                                        <h2 className="text-xl font-bold text-white mb-4">Staff per Ruolo</h2>
                                        <div className="space-y-3">
                                            {[...new Set(staff.map(s => s.role))].map(role => {
                                                const members = staff.filter(s => s.role === role);
                                                const onDuty = members.filter(s => s.status === 'on-duty').length;
                                                
                                                return (
                                                    <div key={role} className="bg-slate-900/50 rounded-lg p-3">
                                                        <div className="flex justify-between items-center">
                                                            <span className="text-white font-medium">{role}</span>
                                                            <span className="text-purple-300">
                                                                <span className="text-green-400">{onDuty}</span>/{members.length}
                                                            </span>
                                                        </div>
                                                        <div className="mt-2 flex gap-1">
                                                            {members.map(m => (
                                                                <div
                                                                    key={m.id}
                                                                    className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${
                                                                        m.status === 'on-duty' 
                                                                            ? 'bg-green-500 text-white' 
                                                                            : 'bg-slate-600 text-slate-300'
                                                                    }`}
                                                                    title={m.name}
                                                                >
                                                                    {m.name.charAt(0)}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>

                                    <div className="bg-slate-800/50 backdrop-blur-sm border border-purple-500/30 rounded-xl p-6 mb-6">
                                        <h2 className="text-xl font-bold text-white mb-4">Costi Stimati</h2>
                                        <div className="space-y-2">
                                            {staff.filter(s => s.hourlyRate > 0).map(member => {
                                                let hours = 0;
                                                if (member.checkInTime) {
                                                    const checkIn = new Date(member.checkInTime);
                                                    const checkOut = member.checkOutTime ? new Date(member.checkOutTime) : new Date();
                                                    hours = (checkOut - checkIn) / (1000 * 60 * 60);
                                                }
                                                const cost = hours * member.hourlyRate;
                                                
                                                return (
                                                    <div key={member.id} className="flex justify-between text-sm">
                                                        <span className="text-purple-300">{member.name}</span>
                                                        <span className="text-white">
                                                            {hours.toFixed(1)}h × €{member.hourlyRate} = <span className="text-yellow-400">€{cost.toFixed(2)}</span>
                                                        </span>
                                                    </div>
                                                );
                                            })}
                                            <div className="border-t border-purple-500/30 pt-2 mt-2 flex justify-between font-bold">
                                                <span className="text-white">Totale</span>
                                                <span className="text-yellow-400">
                                                    €{staff.reduce((sum, m) => {
                                                        if (!m.hourlyRate || !m.checkInTime) return sum;
                                                        const checkIn = new Date(m.checkInTime);
                                                        const checkOut = m.checkOutTime ? new Date(m.checkOutTime) : new Date();
                                                        const hours = (checkOut - checkIn) / (1000 * 60 * 60);
                                                        return sum + (hours * m.hourlyRate);
                                                    }, 0).toFixed(2)}
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-slate-800/50 backdrop-blur-sm border border-purple-500/30 rounded-xl p-6">
                                        <h2 className="text-xl font-bold text-white mb-4">Link App Camerieri</h2>
                                        <p className="text-purple-300 text-sm mb-4">
                                            Condividi questo link con i camerieri per vedere ordini e chiamate in tempo reale.
                                        </p>
                                        <button
                                            onClick={() => {
                                                const baseUrl = window.location.origin + window.location.pathname.replace(/gestione-tavoli\.html.*$/, '');
                                                const link = `${baseUrl}waiter-app.html?event=${currentEvent.id}`;
                                                navigator.clipboard.writeText(link);
                                                alert(`Link copiato!\n\n${link}\n\nInvialo ai camerieri via WhatsApp.`);
                                            }}
                                            className="w-full bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-600 hover:to-green-700 text-white py-3 rounded-lg font-bold transition-all flex items-center justify-center gap-2"
                                        >
                                            🔗 Copia Link Camerieri
                                        </button>
                                    </div>
                                </div>
                            </div>
                        ) : showPrView ? (
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                {/* PR List */}
                                <div className="lg:col-span-2">
                                    <div className="bg-slate-800/50 backdrop-blur-sm border border-purple-500/30 rounded-xl p-6">
                                        <div className="flex justify-between items-center mb-4">
                                            <h2 className="text-2xl font-bold text-white">PR / Promoter</h2>
                                            <button
                                                onClick={() => setShowNewPr(true)}
                                                className="bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-all text-sm"
                                            >
                                                <Plus size={16} />
                                                Nuovo PR
                                            </button>
                                        </div>
                                        <div className="space-y-3 max-h-[600px] overflow-y-auto">
                                            {prs.map(pr => {
                                                const stats = getPrStats(pr.id);
                                                return (
                                                    <div
                                                        key={pr.id}
                                                        className="bg-slate-900/50 rounded-lg p-4 border border-purple-500/20 hover:border-purple-400/40 transition-all"
                                                    >
                                                        <div className="flex justify-between items-start mb-3">
                                                            <div className="flex-1 cursor-pointer" onClick={() => setSelectedPr(pr)}>
                                                                <h3 className="text-white font-bold text-lg">{pr.name}</h3>
                                                                {pr.phone && <p className="text-purple-300 text-sm">{pr.phone}</p>}
                                                            </div>
                                                            <div className="flex gap-2">
                                                                <button
                                                                    onClick={(e) => {
                                                                        e.stopPropagation();
                                                                        // Generate proper link for GitHub Pages
                                                                        const baseUrl = window.location.origin + window.location.pathname.replace(/gestione-tavoli\.html.*$/, '');
                                                                        const link = `${baseUrl}pr-app.html?event=${currentEvent.id}&pr=${pr.id}`;
                                                                        
                                                                        navigator.clipboard.writeText(link);
                                                                        alert(`Link copiato!\n\n${link}\n\nInvialo al PR via WhatsApp.`);
                                                                    }}
                                                                    className="text-cyan-400 hover:text-cyan-300 text-sm bg-cyan-500/10 px-3 py-1 rounded font-medium"
                                                                    title="Copia link per il PR"
                                                                >
                                                                    🔗 Link
                                                                </button>
                                                                <button
                                                                    onClick={(e) => {
                                                                        e.stopPropagation();
                                                                        removePr(pr.id);
                                                                    }}
                                                                    className="text-red-400 hover:text-red-300"
                                                                >
                                                                    <Trash2 size={16} />
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div className="grid grid-cols-3 gap-2 text-center">
                                                            <div className="bg-purple-500/20 rounded p-2">
                                                                <div className="text-purple-200 text-xs">Lista</div>
                                                                <div className="text-white font-bold">{stats.guestListCount}</div>
                                                            </div>
                                                            <div className="bg-cyan-500/20 rounded p-2">
                                                                <div className="text-cyan-200 text-xs">Tavoli</div>
                                                                <div className="text-white font-bold">{stats.tableBookings}</div>
                                                            </div>
                                                            <div className="bg-green-500/20 rounded p-2">
                                                                <div className="text-green-200 text-xs">Check-in</div>
                                                                <div className="text-white font-bold">{stats.checkedInCount}/{stats.guestListCount}</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                            {prs.length === 0 && (
                                                <div className="text-center py-20 text-purple-300">
                                                    <Users size={48} className="mx-auto mb-4 opacity-50" />
                                                    <p>Nessun PR aggiunto</p>
                                                    <p className="text-sm mt-2">Clicca "Nuovo PR" per iniziare</p>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                {/* Guest List Detail */}
                                <div>
                                    <div className="bg-slate-800/50 backdrop-blur-sm border border-purple-500/30 rounded-xl p-6">
                                        <h2 className="text-2xl font-bold text-white mb-4">
                                            {selectedPr ? `Lista ${selectedPr.name}` : 'Seleziona un PR'}
                                        </h2>
                                        {selectedPr ? (
                                            <>
                                                <div className="flex gap-2 mb-4">
                                                    <button
                                                        onClick={() => {
                                                            const guestName = prompt('Nome ospite:');
                                                            if (!guestName) return;
                                                            const guestCount = parseInt(prompt('Numero persone:', '1') || '1');
                                                            addGuestToList(selectedPr.id, { guestName, guestCount });
                                                        }}
                                                        className="flex-1 bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700 text-white py-2 rounded-lg flex items-center justify-center gap-2 transition-all"
                                                    >
                                                        <Plus size={16} />
                                                        Aggiungi
                                                    </button>
                                                    <button
                                                        onClick={() => setShowImportGuests(true)}
                                                        className="flex-1 bg-cyan-600 hover:bg-cyan-700 text-white py-2 rounded-lg flex items-center justify-center gap-2 transition-all"
                                                    >
                                                        <Upload size={16} />
                                                        Importa Lista
                                                    </button>
                                                </div>
                                                <div className="space-y-2 max-h-[500px] overflow-y-auto">
                                                    {guestLists.filter(g => g.prId === selectedPr.id).map(guest => (
                                                        <div
                                                            key={guest.id}
                                                            className={`rounded-lg p-3 border transition-all ${
                                                                guest.checkedIn
                                                                    ? 'bg-green-500/20 border-green-400/40'
                                                                    : 'bg-slate-900/50 border-purple-500/20'
                                                            }`}
                                                        >
                                                            <div className="flex justify-between items-center">
                                                                <div className="flex-1">
                                                                    <h4 className="text-white font-medium">{guest.guestName}</h4>
                                                                    <p className="text-purple-300 text-xs">{guest.guestCount} {guest.guestCount === 1 ? 'persona' : 'persone'}</p>
                                                                </div>
                                                                <div className="flex gap-2">
                                                                    <button
                                                                        onClick={() => toggleGuestCheckIn(guest.id)}
                                                                        className={`px-3 py-1 rounded text-xs transition-all ${
                                                                            guest.checkedIn
                                                                                ? 'bg-green-500 text-white'
                                                                                : 'bg-slate-700 text-purple-300 hover:bg-slate-600'
                                                                        }`}
                                                                    >
                                                                        {guest.checkedIn ? '✓' : 'Check-in'}
                                                                    </button>
                                                                    <button
                                                                        onClick={() => removeGuestFromList(guest.id)}
                                                                        className="text-red-400 hover:text-red-300"
                                                                    >
                                                                        <X size={16} />
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                    {guestLists.filter(g => g.prId === selectedPr.id).length === 0 && (
                                                        <div className="text-center py-12 text-purple-300">
                                                            <p className="text-sm">Nessun ospite in lista</p>
                                                        </div>
                                                    )}
                                                </div>
                                            </>
                                        ) : (
                                            <div className="text-center py-12 text-purple-300">
                                                <p className="text-sm">Clicca su un PR per vedere la sua lista</p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        ) : (
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div className="lg:col-span-2">
                                <div className="bg-slate-800/50 backdrop-blur-sm border border-purple-500/30 rounded-xl p-6">
                                    <h2 className="text-2xl font-bold text-white mb-4">Piantina Locale</h2>
                                    <div
                                        ref={floorPlanRef}
                                        className="relative bg-slate-900/80 rounded-lg border-2 border-dashed border-purple-500/30 h-[600px] overflow-hidden"
                                        onDrop={handleFloorPlanDrop}
                                        onDragOver={(e) => e.preventDefault()}
                                    >
                                        {tables.map(table => {
                                            const status = getTableStatus(table);
                                            const booking = getTableBooking(table.id);
                                            const width = table.width || 80;
                                            const height = table.height || 80;
                                            
                                            return (
                                                <div
                                                    key={table.id}
                                                    draggable={editMode && !resizingTable}
                                                    onDragStart={(e) => handleTableDragStart(e, table)}
                                                    onClick={() => {
                                                        if (editMode && !resizingTable) {
                                                            setEditingTable(table);
                                                        } else if (!editMode) {
                                                            setSelectedTable(table);
                                                        }
                                                    }}
                                                    style={{
                                                        left: `${table.x}px`,
                                                        top: `${table.y}px`,
                                                        width: `${width}px`,
                                                        height: `${height}px`,
                                                        cursor: editMode ? 'move' : 'pointer'
                                                    }}
                                                    className={`absolute flex flex-col items-center justify-center transition-colors ${
                                                        table.shape === 'round' ? 'rounded-full' : 'rounded-lg'
                                                    } ${
                                                        status === 'available'
                                                            ? 'bg-green-500/20 border-2 border-green-400 hover:bg-green-500/30'
                                                            : status === 'reserved'
                                                            ? 'bg-yellow-500/20 border-2 border-yellow-400 hover:bg-yellow-500/30'
                                                            : 'bg-red-500/20 border-2 border-red-400 hover:bg-red-500/30'
                                                    }`}
                                                >
                                                    <span className="text-white font-bold text-lg">{table.number}</span>
                                                    <span className="text-xs text-purple-200">{table.capacity}p</span>
                                                    {booking && (
                                                        <div className="absolute -top-8 left-1/2 transform -translate-x-1/2 bg-purple-600 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-10">
                                                            {booking.guestName}
                                                        </div>
                                                    )}
                                                    {editMode && (
                                                        <>
                                                            {/* Resize handles */}
                                                            <div
                                                                onMouseDown={(e) => handleResizeStart(e, table, 'nw')}
                                                                className="absolute -top-1 -left-1 w-3 h-3 bg-cyan-500 border border-white rounded-full cursor-nw-resize hover:bg-cyan-400 z-20"
                                                            />
                                                            <div
                                                                onMouseDown={(e) => handleResizeStart(e, table, 'ne')}
                                                                className="absolute -top-1 -right-1 w-3 h-3 bg-cyan-500 border border-white rounded-full cursor-ne-resize hover:bg-cyan-400 z-20"
                                                            />
                                                            <div
                                                                onMouseDown={(e) => handleResizeStart(e, table, 'sw')}
                                                                className="absolute -bottom-1 -left-1 w-3 h-3 bg-cyan-500 border border-white rounded-full cursor-sw-resize hover:bg-cyan-400 z-20"
                                                            />
                                                            <div
                                                                onMouseDown={(e) => handleResizeStart(e, table, 'se')}
                                                                className="absolute -bottom-1 -right-1 w-3 h-3 bg-cyan-500 border border-white rounded-full cursor-se-resize hover:bg-cyan-400 z-20"
                                                            />
                                                            
                                                            <button
                                                                onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    removeTable(table.id);
                                                                }}
                                                                className="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 hover:bg-red-600 z-20"
                                                            >
                                                                <X size={12} />
                                                            </button>
                                                            
                                                            <button
                                                                onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    updateTable(table.id, { 
                                                                        shape: table.shape === 'round' ? 'square' : 'round' 
                                                                    });
                                                                }}
                                                                className="absolute bottom-1 left-1/2 transform -translate-x-1/2 bg-purple-500 text-white rounded px-2 py-0.5 hover:bg-purple-600 text-xs z-20"
                                                                title="Cambia forma"
                                                            >
                                                                {table.shape === 'round' ? '⬜' : '⭕'}
                                                            </button>
                                                        </>
                                                    )}
                                                </div>
                                            );
                                        })}
                                        {tables.length === 0 && (
                                            <div className="absolute inset-0 flex items-center justify-center text-purple-300">
                                                <div className="text-center">
                                                    <Users size={48} className="mx-auto mb-4 opacity-50" />
                                                    <p>Clicca "Aggiungi Tavolo" per iniziare</p>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>

                            <div>
                                <div className="bg-slate-800/50 backdrop-blur-sm border border-purple-500/30 rounded-xl p-6">
                                    <h2 className="text-2xl font-bold text-white mb-4">Prenotazioni</h2>
                                    <div className="space-y-3 max-h-[600px] overflow-y-auto">
                                        {bookings.map(booking => {
                                            const table = tables.find(t => t.id === booking.tableId);
                                            return (
                                                <div
                                                    key={booking.id}
                                                    className="bg-slate-900/50 rounded-lg p-4 border border-purple-500/20 hover:border-purple-400/40 transition-all"
                                                >
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div>
                                                            <h3 className="text-white font-bold">{booking.guestName}</h3>
                                                            <p className="text-purple-300 text-sm">Tavolo {table?.number}</p>
                                                        </div>
                                                        <button
                                                            onClick={() => removeBookingById(booking.id)}
                                                            className="text-red-400 hover:text-red-300"
                                                        >
                                                            <Trash2 size={16} />
                                                        </button>
                                                    </div>
                                                    <div className="text-sm text-purple-200 space-y-1">
                                                        <div className="flex items-center gap-2">
                                                            <Users size={14} />
                                                            {booking.guestCount} persone
                                                        </div>
                                                        {booking.prName && (
                                                            <div className="flex items-center gap-2">
                                                                <span className="text-xs bg-pink-500/20 text-pink-300 px-2 py-0.5 rounded">PR: {booking.prName}</span>
                                                            </div>
                                                        )}
                                                        {booking.phone && (
                                                            <div className="flex items-center gap-2">
                                                                <Phone size={14} />
                                                                {booking.phone}
                                                            </div>
                                                        )}
                                                        {booking.notes && (
                                                            <div className="flex items-start gap-2">
                                                                <StickyNote size={14} className="mt-0.5" />
                                                                <span className="text-xs">{booking.notes}</span>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                        {bookings.length === 0 && (
                                            <div className="text-center py-12 text-purple-300">
                                                <p>Nessuna prenotazione</p>
                                                <p className="text-sm mt-2">Clicca su un tavolo per aggiungerne una</p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                        )}
                    </div>

                    {editingTable && (
                        <TableEditModal
                            table={editingTable}
                            onClose={() => setEditingTable(null)}
                            onSave={(updates) => {
                                updateTable(editingTable.id, updates);
                                setEditingTable(null);
                            }}
                        />
                    )}

                    {showNewPr && (
                        <NewPrModal 
                            onClose={() => setShowNewPr(false)} 
                            onCreate={addPr} 
                        />
                    )}

                    {showImportGuests && selectedPr && (
                        <ImportGuestsModal
                            pr={selectedPr}
                            onClose={() => setShowImportGuests(false)}
                            onImport={async (guestsText) => {
                                const count = await importGuestsBatch(selectedPr.id, guestsText);
                                alert(`${count} ospiti importati!`);
                                setShowImportGuests(false);
                            }}
                        />
                    )}

                    {selectedTable && !editMode && (
                        <BookingModal
                            table={selectedTable}
                            existingBooking={getTableBooking(selectedTable.id)}
                            prs={prs}
                            onClose={() => setSelectedTable(null)}
                            onSave={addBooking}
                        />
                    )}
                </div>
            );
        };

        const StatCard = ({ label, value, color }) => (
            <div className="bg-slate-800/50 backdrop-blur-sm border border-purple-500/30 rounded-xl p-6 relative overflow-hidden group">
                <div className={`absolute inset-0 bg-gradient-to-br ${color} opacity-10 group-hover:opacity-20 transition-opacity`} />
                <div className="relative z-10">
                    <p className="text-purple-300 text-sm mb-2">{label}</p>
                    <p className="text-4xl font-black text-white">{value}</p>
                </div>
            </div>
        );

        const NewEventModal = ({ onClose, onCreate }) => {
            const [formData, setFormData] = useState({
                name: '',
                date: '',
                venue: ''
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                onCreate(formData);
            };

            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div className="bg-slate-800 border border-purple-500/30 rounded-xl p-8 max-w-md w-full">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-white">Nuova Serata</h2>
                            <button onClick={onClose} className="text-purple-300 hover:text-white">
                                <X size={24} />
                            </button>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-purple-300 mb-2">Nome Evento</label>
                                <input
                                    type="text"
                                    required
                                    value={formData.name}
                                    onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                                    className="w-full bg-slate-900 border border-purple-500/30 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-purple-400"
                                    placeholder="es. Tech House Night"
                                />
                            </div>
                            <div>
                                <label className="block text-purple-300 mb-2">Data</label>
                                <input
                                    type="date"
                                    required
                                    value={formData.date}
                                    onChange={(e) => setFormData({ ...formData, date: e.target.value })}
                                    className="w-full bg-slate-900 border border-purple-500/30 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-purple-400"
                                />
                            </div>
                            <div>
                                <label className="block text-purple-300 mb-2">Location</label>
                                <input
                                    type="text"
                                    required
                                    value={formData.venue}
                                    onChange={(e) => setFormData({ ...formData, venue: e.target.value })}
                                    className="w-full bg-slate-900 border border-purple-500/30 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-purple-400"
                                    placeholder="es. Parma"
                                />
                            </div>
                            <button
                                type="submit"
                                className="w-full bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700 text-white py-3 rounded-lg transition-all font-bold"
                            >
                                Crea Serata
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const ImportGuestsModal = ({ pr, onClose, onImport }) => {
            const [guestsText, setGuestsText] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!guestsText.trim()) return;
                onImport(guestsText);
            };

            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div className="bg-slate-800 border border-purple-500/30 rounded-xl p-8 max-w-2xl w-full">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-white">Importa Lista - {pr.name}</h2>
                            <button onClick={onClose} className="text-purple-300 hover:text-white">
                                <X size={24} />
                            </button>
                        </div>
                        
                        <div className="mb-4 bg-purple-900/30 border border-purple-500/30 rounded-lg p-4">
                            <h3 className="text-white font-bold mb-2 text-sm">📋 Formati supportati:</h3>
                            <div className="text-purple-200 text-xs space-y-1 font-mono">
                                <div>• <span className="text-green-400">Mario Rossi</span> <span className="text-purple-400">(1 persona)</span></div>
                                <div>• <span className="text-green-400">Luca Bianchi - 2</span> <span className="text-purple-400">(2 persone)</span></div>
                                <div>• <span className="text-green-400">Sara Verdi (4)</span> <span className="text-purple-400">(4 persone)</span></div>
                            </div>
                            <p className="text-purple-300 text-xs mt-2">💡 Un nome per riga. Se non specifichi il numero, default = 1 persona</p>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-purple-300 mb-2">Incolla la tua lista qui:</label>
                                <textarea
                                    value={guestsText}
                                    onChange={(e) => setGuestsText(e.target.value)}
                                    className="w-full bg-slate-900 border border-purple-500/30 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-purple-400 resize-none font-mono text-sm"
                                    rows="12"
                                    placeholder="Mario Rossi&#10;Luca Bianchi - 2&#10;Sara Verdi (3)&#10;Giovanni Neri&#10;..."
                                />
                                <p className="text-purple-400 text-xs mt-2">
                                    {guestsText.split('\n').filter(l => l.trim()).length} righe • 
                                    Circa {guestsText.split('\n').filter(l => l.trim()).length} ospiti
                                </p>
                            </div>
                            <div className="flex gap-3">
                                <button
                                    type="button"
                                    onClick={onClose}
                                    className="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-lg transition-all"
                                >
                                    Annulla
                                </button>
                                <button
                                    type="submit"
                                    className="flex-1 bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700 text-white py-3 rounded-lg transition-all font-bold"
                                >
                                    Importa Lista
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const DeleteConfirmModal = ({ item, onClose, onConfirm }) => {
            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div className="bg-slate-800 border border-red-500/30 rounded-xl p-6 max-w-md w-full">
                        <div className="text-center mb-6">
                            <div className="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                                <Trash2 size={32} className="text-red-400" />
                            </div>
                            <h2 className="text-xl font-bold text-white mb-2">Conferma Eliminazione</h2>
                            <p className="text-purple-300">
                                Sei sicura di voler eliminare <span className="text-white font-bold">"{item.name}"</span>?
                            </p>
                            <p className="text-red-400 text-sm mt-2">Questa azione non può essere annullata.</p>
                        </div>
                        <div className="flex gap-3">
                            <button
                                onClick={onClose}
                                className="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-lg transition-all"
                            >
                                Annulla
                            </button>
                            <button
                                onClick={() => {
                                    onConfirm(item.type, item.id);
                                    onClose();
                                }}
                                className="flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg transition-all font-bold"
                            >
                                Elimina
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const AddMenuItemModal = ({ inventory, onClose, onAdd }) => {
            const [mode, setMode] = useState('inventory'); // 'inventory' | 'manual'
            const [selectedInventoryId, setSelectedInventoryId] = useState('');
            const [customPrice, setCustomPrice] = useState('');
            const [manualName, setManualName] = useState('');
            const [manualCategory, setManualCategory] = useState('');
            const [manualPrice, setManualPrice] = useState('');

            const selectedItem = inventory.find(i => i.id === selectedInventoryId);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (mode === 'inventory') {
                    if (!selectedInventoryId || !customPrice) return;
                    onAdd({
                        name: selectedItem.name,
                        category: selectedItem.category,
                        price: parseFloat(customPrice),
                        inventoryId: selectedInventoryId
                    });
                } else {
                    if (!manualName || !manualCategory || !manualPrice) return;
                    onAdd({
                        name: manualName,
                        category: manualCategory,
                        price: parseFloat(manualPrice)
                    });
                }
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div className="bg-slate-800 border border-purple-500/30 rounded-xl p-6 max-w-md w-full">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold text-white">Aggiungi al Menu</h2>
                            <button onClick={onClose} className="text-purple-300 hover:text-white">
                                <X size={24} />
                            </button>
                        </div>

                        {/* Mode Toggle */}
                        <div className="flex gap-2 mb-6">
                            <button
                                type="button"
                                onClick={() => setMode('inventory')}
                                className={`flex-1 py-2 rounded-lg font-medium transition-all ${
                                    mode === 'inventory' 
                                        ? 'bg-amber-500 text-white' 
                                        : 'bg-slate-700 text-purple-300'
                                }`}
                            >
                                📦 Da Magazzino
                            </button>
                            <button
                                type="button"
                                onClick={() => setMode('manual')}
                                className={`flex-1 py-2 rounded-lg font-medium transition-all ${
                                    mode === 'manual' 
                                        ? 'bg-purple-500 text-white' 
                                        : 'bg-slate-700 text-purple-300'
                                }`}
                            >
                                ✏️ Manuale
                            </button>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-4">
                            {mode === 'inventory' ? (
                                <>
                                    <div>
                                        <label className="block text-purple-300 mb-2">Prodotto dal Magazzino</label>
                                        <select
                                            value={selectedInventoryId}
                                            onChange={(e) => {
                                                setSelectedInventoryId(e.target.value);
                                                const item = inventory.find(i => i.id === e.target.value);
                                                if (item) setCustomPrice(item.unitPrice.toString());
                                            }}
                                            className="w-full bg-slate-900 border border-purple-500/30 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-purple-400"
                                            required
                                        >
                                            <option value="">Seleziona prodotto...</option>
                                            {inventory.map(item => (
                                                <option key={item.id} value={item.id}>
                                                    {item.name} ({item.category}) - {item.currentStock || item.initialStock} disponibili
                                                </option>
                                            ))}
                                        </select>
                                    </div>
                                    {selectedItem && (
                                        <div className="bg-amber-500/10 border border-amber-500/30 rounded-lg p-3">
                                            <div className="text-amber-300 text-sm">
                                                <span className="font-bold">{selectedItem.name}</span>
                                                <span className="ml-2">• Stock: {selectedItem.currentStock || selectedItem.initialStock}</span>
                                                <span className="ml-2">• Costo: €{selectedItem.unitPrice}</span>
                                            </div>
                                        </div>
                                    )}
                                    <div>
                                        <label className="block text-purple-300 mb-2">Prezzo di Vendita €</label>
                                        <input
                                            type="number"
                                            step="0.01"
                                            min="0"
                                            value={customPrice}
                                            onChange={(e) => setCustomPrice(e.target.value)}
                                            className="w-full bg-slate-900 border border-purple-500/30 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-purple-400"
                                            placeholder="Es: 150.00"
                                            required
                                        />
                                    </div>
                                </>
                            ) : (
                                <>
                                    <div>
                                        <label className="block text-purple-300 mb-2">Nome Prodotto</label>
                                        <input
                                            type="text"
                                            value={manualName}
                                            onChange={(e) => setManualName(e.target.value)}
                                            className="w-full bg-slate-900 border border-purple-500/30 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-purple-400"
                                            placeholder="Es: Mojito"
                                            required
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-purple-300 mb-2">Categoria</label>
                                        <input
                                            type="text"
                                            value={manualCategory}
                                            onChange={(e) => setManualCategory(e.target.value)}
                                            className="w-full bg-slate-900 border border-purple-500/30 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-purple-400"
                                            placeholder="Es: Cocktail"
                                            required
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-purple-300 mb-2">Prezzo €</label>
                                        <input
                                            type="number"
                                            step="0.01"
                                            min="0"
                                            value={manualPrice}
                                            onChange={(e) => setManualPrice(e.target.value)}
                                            className="w-full bg-slate-900 border border-purple-500/30 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-purple-400"
                                            placeholder="Es: 12.00"
                                            required
                                        />
                                    </div>
                                </>
                            )}
                            <button
                                type="submit"
                                className="w-full bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700 text-white py-3 rounded-lg transition-all font-bold"
                            >
                                Aggiungi al Menu
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const NewPrModal = ({ onClose, onCreate }) => {
            const [formData, setFormData] = useState({
                name: '',
                phone: '',
                instagram: ''
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                onCreate(formData);
            };

            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div className="bg-slate-800 border border-purple-500/30 rounded-xl p-8 max-w-md w-full">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-white">Nuovo PR</h2>
                            <button onClick={onClose} className="text-purple-300 hover:text-white">
                                <X size={24} />
                            </button>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-purple-300 mb-2">Nome</label>
                                <input
                                    type="text"
                                    required
                                    value={formData.name}
                                    onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                                    className="w-full bg-slate-900 border border-purple-500/30 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-purple-400"
                                    placeholder="Nome PR"
                                />
                            </div>
                            <div>
                                <label className="block text-purple-300 mb-2">Telefono</label>
                                <input
                                    type="tel"
                                    value={formData.phone}
                                    onChange={(e) => setFormData({ ...formData, phone: e.target.value })}
                                    className="w-full bg-slate-900 border border-purple-500/30 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-purple-400"
                                    placeholder="+39 ..."
                                />
                            </div>
                            <div>
                                <label className="block text-purple-300 mb-2">Instagram (opzionale)</label>
                                <input
                                    type="text"
                                    value={formData.instagram}
                                    onChange={(e) => setFormData({ ...formData, instagram: e.target.value })}
                                    className="w-full bg-slate-900 border border-purple-500/30 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-purple-400"
                                    placeholder="@username"
                                />
                            </div>
                            <button
                                type="submit"
                                className="w-full bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700 text-white py-3 rounded-lg transition-all font-bold"
                            >
                                Crea PR
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const TableEditModal = ({ table, onClose, onSave }) => {
            const [formData, setFormData] = useState({
                number: table.number,
                capacity: table.capacity,
                shape: table.shape
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div className="bg-slate-800 border border-purple-500/30 rounded-xl p-8 max-w-md w-full">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-white">Modifica Tavolo {table.number}</h2>
                            <button onClick={onClose} className="text-purple-300 hover:text-white">
                                <X size={24} />
                            </button>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-purple-300 mb-2">Numero Tavolo</label>
                                <input
                                    type="number"
                                    required
                                    min="1"
                                    value={formData.number}
                                    onChange={(e) => setFormData({ ...formData, number: parseInt(e.target.value) })}
                                    className="w-full bg-slate-900 border border-purple-500/30 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-purple-400"
                                />
                            </div>
                            <div>
                                <label className="block text-purple-300 mb-2">Capacità (persone)</label>
                                <input
                                    type="number"
                                    required
                                    min="1"
                                    max="50"
                                    value={formData.capacity}
                                    onChange={(e) => setFormData({ ...formData, capacity: parseInt(e.target.value) })}
                                    className="w-full bg-slate-900 border border-purple-500/30 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-purple-400"
                                />
                            </div>
                            <div>
                                <label className="block text-purple-300 mb-2">Forma</label>
                                <select
                                    value={formData.shape}
                                    onChange={(e) => setFormData({ ...formData, shape: e.target.value })}
                                    className="w-full bg-slate-900 border border-purple-500/30 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-purple-400"
                                >
                                    <option value="round">Rotondo</option>
                                    <option value="square">Quadrato</option>
                                </select>
                            </div>
                            <button
                                type="submit"
                                className="w-full bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700 text-white py-3 rounded-lg transition-all font-bold"
                            >
                                Salva Modifiche
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const BookingModal = ({ table, existingBooking, prs, onClose, onSave }) => {
            const [formData, setFormData] = useState({
                guestName: existingBooking?.guestName || '',
                guestCount: existingBooking?.guestCount || table.capacity,
                phone: existingBooking?.phone || '',
                notes: existingBooking?.notes || '',
                prId: existingBooking?.prId || '',
                prName: existingBooking?.prName || ''
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div className="bg-slate-800 border border-purple-500/30 rounded-xl p-8 max-w-md w-full">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-white">
                                {existingBooking ? 'Prenotazione' : 'Nuova Prenotazione'} - Tavolo {table.number}
                            </h2>
                            <button onClick={onClose} className="text-purple-300 hover:text-white">
                                <X size={24} />
                            </button>
                        </div>
                        {existingBooking ? (
                            <div className="text-purple-200 space-y-3">
                                <p><strong>Ospite:</strong> {existingBooking.guestName}</p>
                                <p><strong>Persone:</strong> {existingBooking.guestCount}</p>
                                {existingBooking.prName && <p><strong>PR:</strong> {existingBooking.prName}</p>}
                                {existingBooking.phone && <p><strong>Telefono:</strong> {existingBooking.phone}</p>}
                                {existingBooking.notes && <p><strong>Note:</strong> {existingBooking.notes}</p>}
                                <button
                                    onClick={onClose}
                                    className="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-lg mt-4"
                                >
                                    Chiudi
                                </button>
                            </div>
                        ) : (
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div>
                                    <label className="block text-purple-300 mb-2">Nome Ospite</label>
                                    <input
                                        type="text"
                                        required
                                        value={formData.guestName}
                                        onChange={(e) => setFormData({ ...formData, guestName: e.target.value })}
                                        className="w-full bg-slate-900 border border-purple-500/30 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-purple-400"
                                        placeholder="Nome e cognome"
                                    />
                                </div>
                                <div>
                                    <label className="block text-purple-300 mb-2">Numero Persone</label>
                                    <input
                                        type="number"
                                        required
                                        min="1"
                                        max={table.capacity}
                                        value={formData.guestCount}
                                        onChange={(e) => setFormData({ ...formData, guestCount: parseInt(e.target.value) })}
                                        className="w-full bg-slate-900 border border-purple-500/30 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-purple-400"
                                    />
                                </div>
                                <div>
                                    <label className="block text-purple-300 mb-2">Telefono (opzionale)</label>
                                    <input
                                        type="tel"
                                        value={formData.phone}
                                        onChange={(e) => setFormData({ ...formData, phone: e.target.value })}
                                        className="w-full bg-slate-900 border border-purple-500/30 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-purple-400"
                                        placeholder="+39 ..."
                                    />
                                </div>
                                <div>
                                    <label className="block text-purple-300 mb-2">PR / Promoter (opzionale)</label>
                                    <select
                                        value={formData.prId}
                                        onChange={(e) => {
                                            const selectedPr = prs.find(p => p.id === e.target.value);
                                            setFormData({ 
                                                ...formData, 
                                                prId: e.target.value,
                                                prName: selectedPr?.name || ''
                                            });
                                        }}
                                        className="w-full bg-slate-900 border border-purple-500/30 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-purple-400"
                                    >
                                        <option value="">Nessun PR</option>
                                        {prs.map(pr => (
                                            <option key={pr.id} value={pr.id}>{pr.name}</option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-purple-300 mb-2">Note (opzionale)</label>
                                    <textarea
                                        value={formData.notes}
                                        onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                                        className="w-full bg-slate-900 border border-purple-500/30 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-purple-400 resize-none"
                                        rows="3"
                                        placeholder="Allergie, richieste speciali..."
                                    />
                                </div>
                                <button
                                    type="submit"
                                    className="w-full bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700 text-white py-3 rounded-lg transition-all font-bold"
                                >
                                    Conferma Prenotazione
                                </button>
                            </form>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<EventTablesManager />, document.getElementById('root'));
    </script>
</body>
</html>
