<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@_muse.in_ - Lista PR</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, sans-serif;
        }
        
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(100, 100, 100, 0.1);
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(168, 85, 247, 0.5);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(168, 85, 247, 0.7);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Icons
        const Plus = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M5 12h14"/><path d="M12 5v14"/>
            </svg>
        );

        const X = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
            </svg>
        );

        const Users = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
        );

        const Upload = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/>
            </svg>
        );

        const CheckCircle = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
        );

        // Storage wrapper
        const storage = {
            async get(key, shared = false) {
                try {
                    const value = localStorage.getItem(key);
                    return value ? { key, value, shared } : null;
                } catch (error) {
                    console.error('Storage get error:', error);
                    return null;
                }
            },
            async set(key, value, shared = false) {
                try {
                    localStorage.setItem(key, value);
                    return { key, value, shared };
                } catch (error) {
                    console.error('Storage set error:', error);
                    return null;
                }
            }
        };

        window.storage = storage;

        const PrApp = () => {
            const [event, setEvent] = useState(null);
            const [pr, setPr] = useState(null);
            const [guestList, setGuestList] = useState([]);
            const [showImport, setShowImport] = useState(false);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                loadData();
            }, []);

            const loadData = async () => {
                // Parse URL parameters
                const params = new URLSearchParams(window.location.search);
                const eventId = params.get('event');
                const prId = params.get('pr');

                if (!eventId || !prId) {
                    setError('Link non valido. Contatta l\'organizzatore.');
                    setLoading(false);
                    return;
                }

                try {
                    // Load event
                    const eventsResult = await window.storage.get('muse-events');
                    if (eventsResult) {
                        const events = JSON.parse(eventsResult.value);
                        const foundEvent = events.find(e => e.id === eventId);
                        if (foundEvent) {
                            setEvent(foundEvent);
                        } else {
                            setError('Evento non trovato.');
                            setLoading(false);
                            return;
                        }
                    }

                    // Load PR info
                    const prsResult = await window.storage.get(`muse-prs-${eventId}`, true);
                    if (prsResult) {
                        const prs = JSON.parse(prsResult.value);
                        const foundPr = prs.find(p => p.id === prId);
                        if (foundPr) {
                            setPr(foundPr);
                        } else {
                            setError('PR non trovato.');
                            setLoading(false);
                            return;
                        }
                    }

                    // Load guest list
                    const guestListResult = await window.storage.get(`muse-guestlists-${eventId}`, true);
                    if (guestListResult) {
                        const allGuests = JSON.parse(guestListResult.value);
                        const myGuests = allGuests.filter(g => g.prId === prId);
                        setGuestList(myGuests);
                    }

                    setLoading(false);
                } catch (error) {
                    console.error('Error loading data:', error);
                    setError('Errore nel caricamento dei dati.');
                    setLoading(false);
                }
            };

            const saveGuestList = async (newGuestList) => {
                try {
                    // Load all guests
                    const guestListResult = await window.storage.get(`muse-guestlists-${event.id}`, true);
                    let allGuests = [];
                    if (guestListResult) {
                        allGuests = JSON.parse(guestListResult.value);
                    }

                    // Remove old guests for this PR
                    allGuests = allGuests.filter(g => g.prId !== pr.id);
                    
                    // Add new guests
                    allGuests = [...allGuests, ...newGuestList];

                    // Save
                    await window.storage.set(`muse-guestlists-${event.id}`, JSON.stringify(allGuests), true);
                    setGuestList(newGuestList);
                } catch (error) {
                    console.error('Error saving guest list:', error);
                    alert('Errore nel salvataggio');
                }
            };

            const addGuest = async (guestName, guestCount) => {
                const newGuest = {
                    id: `${Date.now()}-${Math.random()}`,
                    prId: pr.id,
                    guestName,
                    guestCount: parseInt(guestCount),
                    checkedIn: false,
                    createdAt: new Date().toISOString()
                };
                await saveGuestList([...guestList, newGuest]);
            };

            const removeGuest = async (guestId) => {
                const newGuestList = guestList.filter(g => g.id !== guestId);
                await saveGuestList(newGuestList);
            };

            const toggleCheckIn = async (guestId) => {
                const newGuestList = guestList.map(g =>
                    g.id === guestId ? { ...g, checkedIn: !g.checkedIn } : g
                );
                await saveGuestList(newGuestList);
            };

            const importGuests = async (guestsText) => {
                const lines = guestsText.split('\n').filter(line => line.trim());
                const newGuests = [];
                
                lines.forEach(line => {
                    line = line.trim();
                    if (!line) return;
                    
                    let guestName = line;
                    let guestCount = 1;
                    
                    const dashMatch = line.match(/^(.+?)\s*-\s*(\d+)$/);
                    if (dashMatch) {
                        guestName = dashMatch[1].trim();
                        guestCount = parseInt(dashMatch[2]);
                    } else {
                        const parenMatch = line.match(/^(.+?)\s*\((\d+)\)$/);
                        if (parenMatch) {
                            guestName = parenMatch[1].trim();
                            guestCount = parseInt(parenMatch[2]);
                        }
                    }
                    
                    if (guestName) {
                        newGuests.push({
                            id: `${Date.now()}-${Math.random()}`,
                            prId: pr.id,
                            guestName,
                            guestCount,
                            checkedIn: false,
                            createdAt: new Date().toISOString()
                        });
                    }
                });
                
                if (newGuests.length > 0) {
                    await saveGuestList([...guestList, ...newGuests]);
                    return newGuests.length;
                }
                return 0;
            };

            if (loading) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex items-center justify-center p-4">
                        <div className="text-white text-xl">Caricamento...</div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex items-center justify-center p-4">
                        <div className="bg-slate-800/50 backdrop-blur-sm border border-red-500/30 rounded-xl p-8 max-w-md text-center">
                            <div className="text-red-400 text-xl mb-4">‚ö†Ô∏è Errore</div>
                            <div className="text-purple-200">{error}</div>
                        </div>
                    </div>
                );
            }

            const totalGuests = guestList.reduce((sum, g) => sum + g.guestCount, 0);
            const checkedInGuests = guestList.filter(g => g.checkedIn).length;
            const checkedInCount = guestList.filter(g => g.checkedIn).reduce((sum, g) => sum + g.guestCount, 0);

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-4">
                    <div className="max-w-2xl mx-auto">
                        {/* Header */}
                        <header className="mb-8 text-center">
                            <h1 className="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-400 via-purple-400 to-cyan-400 mb-2 tracking-tight">
                                @_muse.in_
                            </h1>
                            <h2 className="text-2xl font-bold text-white mb-2">{event.name}</h2>
                            <p className="text-purple-300">
                                {new Date(event.date).toLocaleDateString('it-IT')} ‚Ä¢ {event.venue}
                            </p>
                            <div className="mt-4 inline-block bg-gradient-to-r from-pink-500 to-purple-600 text-white px-6 py-2 rounded-full font-bold">
                                PR: {pr.name}
                            </div>
                        </header>

                        {/* Stats */}
                        <div className="grid grid-cols-3 gap-4 mb-6">
                            <div className="bg-slate-800/50 backdrop-blur-sm border border-purple-500/30 rounded-xl p-4 text-center">
                                <div className="text-purple-300 text-sm mb-1">Lista</div>
                                <div className="text-3xl font-black text-white">{guestList.length}</div>
                            </div>
                            <div className="bg-slate-800/50 backdrop-blur-sm border border-purple-500/30 rounded-xl p-4 text-center">
                                <div className="text-purple-300 text-sm mb-1">Ospiti</div>
                                <div className="text-3xl font-black text-white">{totalGuests}</div>
                            </div>
                            <div className="bg-slate-800/50 backdrop-blur-sm border border-purple-500/30 rounded-xl p-4 text-center">
                                <div className="text-purple-300 text-sm mb-1">Check-in</div>
                                <div className="text-3xl font-black text-white">{checkedInGuests}/{guestList.length}</div>
                            </div>
                        </div>

                        {/* Actions */}
                        <div className="flex gap-3 mb-6">
                            <button
                                onClick={() => {
                                    const guestName = prompt('Nome ospite:');
                                    if (!guestName) return;
                                    const guestCount = parseInt(prompt('Numero persone:', '1') || '1');
                                    addGuest(guestName, guestCount);
                                }}
                                className="flex-1 bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700 text-white py-4 rounded-xl flex items-center justify-center gap-2 transition-all font-bold shadow-lg shadow-purple-500/50"
                            >
                                <Plus size={20} />
                                Aggiungi Ospite
                            </button>
                            <button
                                onClick={() => setShowImport(true)}
                                className="flex-1 bg-cyan-600 hover:bg-cyan-700 text-white py-4 rounded-xl flex items-center justify-center gap-2 transition-all font-bold shadow-lg shadow-cyan-500/50"
                            >
                                <Upload size={20} />
                                Importa Lista
                            </button>
                        </div>

                        {/* Guest List */}
                        <div className="bg-slate-800/50 backdrop-blur-sm border border-purple-500/30 rounded-xl p-6">
                            <h3 className="text-xl font-bold text-white mb-4">La Tua Lista</h3>
                            <div className="space-y-3 max-h-[500px] overflow-y-auto">
                                {guestList.map(guest => (
                                    <div
                                        key={guest.id}
                                        className={`rounded-lg p-4 border transition-all ${
                                            guest.checkedIn
                                                ? 'bg-green-500/20 border-green-400/40'
                                                : 'bg-slate-900/50 border-purple-500/20'
                                        }`}
                                    >
                                        <div className="flex justify-between items-center">
                                            <div className="flex-1">
                                                <h4 className="text-white font-bold text-lg">{guest.guestName}</h4>
                                                <p className="text-purple-300 text-sm">
                                                    {guest.guestCount} {guest.guestCount === 1 ? 'persona' : 'persone'}
                                                </p>
                                            </div>
                                            <div className="flex gap-2">
                                                <button
                                                    onClick={() => toggleCheckIn(guest.id)}
                                                    className={`px-4 py-2 rounded-lg transition-all font-bold ${
                                                        guest.checkedIn
                                                            ? 'bg-green-500 text-white'
                                                            : 'bg-slate-700 text-purple-300 hover:bg-slate-600'
                                                    }`}
                                                >
                                                    {guest.checkedIn ? (
                                                        <span className="flex items-center gap-1">
                                                            <CheckCircle size={16} />
                                                            Arrivato
                                                        </span>
                                                    ) : (
                                                        'Check-in'
                                                    )}
                                                </button>
                                                <button
                                                    onClick={() => {
                                                        if (confirm(`Rimuovere ${guest.guestName}?`)) {
                                                            removeGuest(guest.id);
                                                        }
                                                    }}
                                                    className="text-red-400 hover:text-red-300 px-2"
                                                >
                                                    <X size={20} />
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                                {guestList.length === 0 && (
                                    <div className="text-center py-12 text-purple-300">
                                        <Users size={48} className="mx-auto mb-4 opacity-50" />
                                        <p>Nessun ospite in lista</p>
                                        <p className="text-sm mt-2">Aggiungi il primo ospite!</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {showImport && (
                        <ImportModal
                            onClose={() => setShowImport(false)}
                            onImport={async (text) => {
                                const count = await importGuests(text);
                                alert(`${count} ospiti importati!`);
                                setShowImport(false);
                            }}
                        />
                    )}
                </div>
            );
        };

        const ImportModal = ({ onClose, onImport }) => {
            const [guestsText, setGuestsText] = useState('');

            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div className="bg-slate-800 border border-purple-500/30 rounded-xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-white">Importa Lista</h2>
                            <button onClick={onClose} className="text-purple-300 hover:text-white">
                                <X size={24} />
                            </button>
                        </div>
                        
                        <div className="mb-4 bg-purple-900/30 border border-purple-500/30 rounded-lg p-4">
                            <h3 className="text-white font-bold mb-2 text-sm">üìã Formati supportati:</h3>
                            <div className="text-purple-200 text-xs space-y-1 font-mono">
                                <div>‚Ä¢ <span className="text-green-400">Mario Rossi</span> <span className="text-purple-400">(1 persona)</span></div>
                                <div>‚Ä¢ <span className="text-green-400">Luca Bianchi - 2</span> <span className="text-purple-400">(2 persone)</span></div>
                                <div>‚Ä¢ <span className="text-green-400">Sara Verdi (4)</span> <span className="text-purple-400">(4 persone)</span></div>
                            </div>
                            <p className="text-purple-300 text-xs mt-2">üí° Un nome per riga</p>
                        </div>

                        <div className="space-y-4">
                            <textarea
                                value={guestsText}
                                onChange={(e) => setGuestsText(e.target.value)}
                                className="w-full bg-slate-900 border border-purple-500/30 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-purple-400 resize-none font-mono text-sm"
                                rows="12"
                                placeholder="Mario Rossi&#10;Luca Bianchi - 2&#10;Sara Verdi (3)&#10;..."
                            />
                            <p className="text-purple-400 text-xs">
                                {guestsText.split('\n').filter(l => l.trim()).length} righe
                            </p>
                            <div className="flex gap-3">
                                <button
                                    onClick={onClose}
                                    className="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-lg transition-all"
                                >
                                    Annulla
                                </button>
                                <button
                                    onClick={() => {
                                        if (guestsText.trim()) {
                                            onImport(guestsText);
                                        }
                                    }}
                                    className="flex-1 bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700 text-white py-3 rounded-lg transition-all font-bold"
                                >
                                    Importa
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<PrApp />, document.getElementById('root'));
    </script>
</body>
</html>
