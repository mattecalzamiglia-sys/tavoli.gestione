<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@_muse.in_ - Badge Staff QR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-4">
    <div id="root" class="max-w-4xl mx-auto">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-cyan-400 mb-2">üé´ Badge Staff QR</h1>
            <p class="text-purple-300">Genera e stampa i badge per il check-in/out</p>
        </div>
        <div id="loading" class="text-center py-16">
            <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-purple-500 mx-auto mb-4"></div>
            <p class="text-purple-300">Caricamento staff...</p>
        </div>
        <div id="badges" class="grid grid-cols-1 md:grid-cols-2 gap-6" style="display:none;"></div>
        <div id="error" class="bg-red-500/20 border border-red-500/40 rounded-xl p-8 text-center" style="display:none;">
            <div class="text-6xl mb-4">‚ö†Ô∏è</div>
            <p id="error-msg" class="text-red-300"></p>
        </div>
    </div>

    <script>
        firebase.initializeApp({
            apiKey: "AIzaSyA-m6tX87TZtqTDg2kuE04zDvxkJ_vH2Yg",
            authDomain: "gestionale-discoteche-2026.firebaseapp.com",
            projectId: "gestionale-discoteche-2026",
            storageBucket: "gestionale-discoteche-2026.firebasestorage.app",
            messagingSenderId: "299126578946",
            appId: "1:299126578946:web:2609823671a0eed056ac1b"
        });
        var db = firebase.firestore();

        async function loadStaff() {
            var params = new URLSearchParams(window.location.search);
            var eventId = params.get('event');

            if (!eventId) {
                showError('Link non valido. Manca event ID.');
                return;
            }

            try {
                var eventDoc = await db.collection('events').doc(eventId).get();
                if (!eventDoc.exists) {
                    showError('Evento non trovato.');
                    return;
                }

                var eventData = eventDoc.data();
                var staffSnap = await db.collection('events').doc(eventId).collection('staff').get();
                var staffList = staffSnap.docs.map(function(d) { return {id: d.id, ...d.data()}; });

                if (staffList.length === 0) {
                    showError('Nessuno staff trovato per questo evento.');
                    return;
                }

                document.getElementById('loading').style.display = 'none';
                document.getElementById('badges').style.display = 'grid';

                // Create badges
                var badgesContainer = document.getElementById('badges');
                
                for (var i = 0; i < staffList.length; i++) {
                    var member = staffList[i];
                    var badge = createBadge(eventData, eventId, member);
                    badgesContainer.appendChild(badge);
                    
                    // Generate QR code
                    var qrData = JSON.stringify({
                        type: 'staff-checkin',
                        eventId: eventId,
                        staffId: member.id
                    });
                    
                    await QRCode.toCanvas(document.getElementById('qr-' + member.id), qrData, {
                        width: 150,
                        margin: 2,
                        color: { dark: '#000000', light: '#ffffff' }
                    });
                }

            } catch(e) {
                console.error(e);
                showError('Errore caricamento: ' + e.message);
            }
        }

        function createBadge(event, eventId, member) {
            var div = document.createElement('div');
            div.className = 'bg-white rounded-xl p-6 text-center shadow-lg';
            div.innerHTML = `
                <div class="border-b-2 border-purple-200 pb-4 mb-4">
                    <h2 class="text-2xl font-black text-purple-600">@_muse.in_</h2>
                    <p class="text-gray-500 text-sm">${event.name || 'Evento'}</p>
                    <p class="text-gray-400 text-xs">${event.date ? new Date(event.date).toLocaleDateString('it-IT') : ''}</p>
                </div>
                <canvas id="qr-${member.id}" class="mx-auto mb-4"></canvas>
                <div class="border-t-2 border-purple-200 pt-4">
                    <h3 class="text-xl font-bold text-gray-800">${member.name}</h3>
                    <p class="text-purple-600 font-medium">${member.role || 'Staff'}</p>
                </div>
                <button onclick="printBadge(this.parentElement)" class="mt-4 bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-purple-700 print:hidden">
                    üñ®Ô∏è Stampa Badge
                </button>
            `;
            return div;
        }

        function printBadge(element) {
            var printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Badge Staff</title>
                    <style>
                        body { font-family: system-ui, sans-serif; padding: 20px; }
                        .badge { width: 300px; border: 2px solid #9333ea; border-radius: 16px; padding: 24px; text-align: center; }
                        .title { font-size: 24px; font-weight: 900; color: #9333ea; }
                        .event { color: #666; font-size: 14px; }
                        .name { font-size: 20px; font-weight: bold; margin-top: 16px; }
                        .role { color: #9333ea; font-weight: 500; }
                        canvas { margin: 16px auto; display: block; }
                        button { display: none; }
                    </style>
                </head>
                <body>
                    <div class="badge">${element.innerHTML}</div>
                </body>
                </html>
            `);
            printWindow.document.close();
            setTimeout(function() {
                printWindow.print();
            }, 500);
        }

        function showError(msg) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error-msg').textContent = msg;
        }

        loadStaff();
    </script>
</body>
</html>
