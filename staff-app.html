<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@_muse.in_ - Staff</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }
        .call-pulse { position: relative; }
        .call-pulse::before { content: ''; position: absolute; inset: -8px; border-radius: 12px; border: 2px solid #f97316; animation: pulse-ring 1.5s infinite; }
        #qr-reader { width: 100%; }
        #qr-reader video { width: 100% !important; border-radius: 12px; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script>
        firebase.initializeApp({
            apiKey: "AIzaSyA-m6tX87TZtqTDg2kuE04zDvxkJ_vH2Yg",
            authDomain: "gestionale-discoteche-2026.firebaseapp.com",
            projectId: "gestionale-discoteche-2026",
            storageBucket: "gestionale-discoteche-2026.firebasestorage.app",
            messagingSenderId: "299126578946",
            appId: "1:299126578946:web:2609823671a0eed056ac1b"
        });
        var db = firebase.firestore();
        var useState = React.useState;
        var useEffect = React.useEffect;
        var useRef = React.useRef;
        var h = React.createElement;

        function App() {
            var _s1 = useState(null), event = _s1[0], setEvent = _s1[1];
            var _s2 = useState(null), currentStaff = _s2[0], setCurrentStaff = _s2[1];
            var _s3 = useState([]), tables = _s3[0], setTables = _s3[1];
            var _s4 = useState([]), orders = _s4[0], setOrders = _s4[1];
            var _s5 = useState([]), calls = _s5[0], setCalls = _s5[1];
            var _s6 = useState([]), bookings = _s6[0], setBookings = _s6[1];
            var _s7 = useState(true), loading = _s7[0], setLoading = _s7[1];
            var _s8 = useState(null), error = _s8[0], setError = _s8[1];
            var _s9 = useState('status'), tab = _s9[0], setTab = _s9[1];
            var _s10 = useState(false), showScanner = _s10[0], setShowScanner = _s10[1];
            var _s11 = useState(null), scanResult = _s11[0], setScanResult = _s11[1];
            var unsubs = useRef([]);
            var scannerRef = useRef(null);

            // Check if staff is a waiter (cameriere)
            var isWaiter = currentStaff && (
                currentStaff.role.toLowerCase() === 'cameriere' || 
                currentStaff.role.toLowerCase() === 'cameriera' ||
                currentStaff.role.toLowerCase() === 'waiter' ||
                currentStaff.role.toLowerCase() === 'waitress'
            );

            useEffect(function() {
                var params = new URLSearchParams(window.location.search);
                var eventId = params.get('event');
                var staffId = params.get('staff');
                
                if (!eventId || !staffId) { 
                    setError('Link non valido.'); 
                    setLoading(false); 
                    return; 
                }

                (async function() {
                    try {
                        // Load event
                        var eventDoc = await db.collection('events').doc(eventId).get();
                        if (!eventDoc.exists) { 
                            setError('Evento non trovato.'); 
                            setLoading(false); 
                            return; 
                        }
                        setEvent({ id: eventDoc.id, ...eventDoc.data() });

                        // Load staff member
                        var staffDoc = await db.collection('events').doc(eventId).collection('staff').doc(staffId).get();
                        if (!staffDoc.exists) { 
                            setError('Staff non trovato.'); 
                            setLoading(false); 
                            return; 
                        }
                        setCurrentStaff({ id: staffDoc.id, ...staffDoc.data() });

                        // Real-time listeners (needed for waiters)
                        unsubs.current.push(db.collection('events').doc(eventId).collection('tables').onSnapshot(function(s) {
                            setTables(s.docs.map(function(d) { return {id: d.id, ...d.data()}; }));
                        }));
                        
                        unsubs.current.push(db.collection('events').doc(eventId).collection('bookings').onSnapshot(function(s) {
                            setBookings(s.docs.map(function(d) { return {id: d.id, ...d.data()}; }));
                        }));
                        
                        unsubs.current.push(db.collection('events').doc(eventId).collection('orders').onSnapshot(function(s) {
                            setOrders(s.docs.map(function(d) { return {id: d.id, ...d.data()}; }));
                        }));
                        
                        unsubs.current.push(db.collection('events').doc(eventId).collection('waiterCalls').where('status', '==', 'pending').onSnapshot(function(s) {
                            setCalls(s.docs.map(function(d) { return {id: d.id, ...d.data()}; }));
                        }));

                        // Listen for staff updates (for check-in status)
                        unsubs.current.push(db.collection('events').doc(eventId).collection('staff').doc(staffId).onSnapshot(function(doc) {
                            if (doc.exists) {
                                setCurrentStaff({ id: doc.id, ...doc.data() });
                            }
                        }));

                        setLoading(false);
                    } catch(e) { 
                        console.error(e);
                        setError('Errore caricamento.'); 
                        setLoading(false); 
                    }
                })();
                
                return function() { 
                    unsubs.current.forEach(function(u) { u(); }); 
                };
            }, []);

            // Toggle check-in/out for current staff
            var toggleMyCheckIn = async function() {
                var params = new URLSearchParams(window.location.search);
                var eventId = params.get('event');
                var now = new Date().toISOString();
                var isCheckingIn = currentStaff.status === 'off-duty' || !currentStaff.status;

                await db.collection('events').doc(eventId).collection('staff').doc(currentStaff.id).update(
                    isCheckingIn 
                        ? { status: 'on-duty', checkInTime: now }
                        : { status: 'off-duty', checkOutTime: now }
                );
            };

            // Clear waiter call
            var clearCall = async function(cid) {
                var params = new URLSearchParams(window.location.search);
                var eventId = params.get('event');
                await db.collection('events').doc(eventId).collection('waiterCalls').doc(cid).update({
                    status: 'completed',
                    completedAt: new Date().toISOString()
                });
            };

            // Update order status
            var updateOrderStatus = async function(orderId, newStatus) {
                var params = new URLSearchParams(window.location.search);
                var eventId = params.get('event');
                await db.collection('events').doc(eventId).collection('orders').doc(orderId).update({
                    status: newStatus,
                    updatedAt: new Date().toISOString()
                });
            };

            var timeSince = function(date) { 
                var d = Math.floor((new Date() - new Date(date)) / 1000 / 60); 
                return d < 1 ? 'Ora' : d < 60 ? d + 'm fa' : Math.floor(d/60) + 'h ' + (d % 60) + 'm'; 
            };

            var getWorkedHours = function() {
                if (!currentStaff || !currentStaff.checkInTime) return 0;
                var checkIn = new Date(currentStaff.checkInTime);
                var checkOut = currentStaff.checkOutTime ? new Date(currentStaff.checkOutTime) : new Date();
                return ((checkOut - checkIn) / (1000 * 60 * 60)).toFixed(1);
            };

            if (loading) {
                return h('div', {className: 'min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex items-center justify-center'},
                    h('div', {className: 'animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-purple-500'})
                );
            }

            if (error) {
                return h('div', {className: 'min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex items-center justify-center p-4'},
                    h('div', {className: 'bg-red-500/20 border border-red-500/40 rounded-xl p-8 text-center'},
                        h('div', {className: 'text-6xl mb-4'}, 'âš ï¸'),
                        h('p', {className: 'text-red-300'}, error)
                    )
                );
            }

            var isOnDuty = currentStaff.status === 'on-duty';
            var pendingOrders = orders.filter(function(o) { return o.status === 'pending' || !o.status; });
            var preparingOrders = orders.filter(function(o) { return o.status === 'preparing'; });
            var readyOrders = orders.filter(function(o) { return o.status === 'ready'; });

            return h('div', {className: 'min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900'},
                // Header
                h('header', {className: 'sticky top-0 bg-slate-900/95 backdrop-blur-sm border-b border-purple-500/30 px-4 py-3 z-50'},
                    h('div', {className: 'flex justify-between items-center mb-3'},
                        h('div', {},
                            h('h1', {className: 'text-xl font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-cyan-400'}, currentStaff.name),
                            h('p', {className: 'text-purple-300 text-xs'}, currentStaff.role, ' â€¢ ', event ? event.name : '')
                        ),
                        h('div', {className: 'flex items-center gap-2'},
                            h('div', {className: isOnDuty ? 'text-green-400 text-xs' : 'text-slate-400 text-xs'}, isOnDuty ? 'â— In servizio' : 'â—‹ Fuori servizio')
                        )
                    ),
                    // Tabs - different based on role
                    isWaiter ? h('div', {className: 'flex gap-2'},
                        h('button', {
                            onClick: function() { setTab('status'); },
                            className: 'flex-1 py-2 rounded-lg font-bold text-sm ' + (tab === 'status' ? 'bg-purple-500 text-white' : 'bg-slate-800 text-purple-300')
                        }, 'ðŸ‘¤ Stato'),
                        h('button', {
                            onClick: function() { setTab('orders'); },
                            className: 'flex-1 py-2 rounded-lg font-bold text-sm ' + (tab === 'orders' ? 'bg-pink-500 text-white' : 'bg-slate-800 text-purple-300')
                        }, 'ðŸ¾ Ordini ', pendingOrders.length > 0 ? h('span', {className: 'bg-white text-pink-600 text-xs px-2 rounded-full ml-1'}, pendingOrders.length) : null),
                        h('button', {
                            onClick: function() { setTab('calls'); },
                            className: 'flex-1 py-2 rounded-lg font-bold text-sm flex items-center justify-center gap-1 ' + (tab === 'calls' ? 'bg-orange-500 text-white' : 'bg-slate-800 text-purple-300')
                        }, 'ðŸ”” ', calls.length > 0 ? h('span', {className: 'bg-white text-orange-600 text-xs px-2 rounded-full'}, calls.length) : '0'),
                        h('button', {
                            onClick: function() { setTab('tables'); },
                            className: 'flex-1 py-2 rounded-lg font-bold text-sm ' + (tab === 'tables' ? 'bg-cyan-500 text-white' : 'bg-slate-800 text-purple-300')
                        }, 'ðŸª‘')
                    ) : null
                ),

                // Main content
                h('main', {className: 'p-4 pb-24'},
                    // STATUS TAB (everyone sees this)
                    tab === 'status' && h('div', {className: 'space-y-6'},
                        // Check-in/out card
                        h('div', {className: 'bg-slate-800/50 border-2 ' + (isOnDuty ? 'border-green-500' : 'border-purple-500/30') + ' rounded-xl p-6 text-center'},
                            h('div', {className: 'text-6xl mb-4'}, isOnDuty ? 'âœ…' : 'ðŸ”˜'),
                            h('h2', {className: 'text-2xl font-bold text-white mb-2'}, isOnDuty ? 'Sei in Servizio' : 'Non in Servizio'),
                            isOnDuty && currentStaff.checkInTime && h('p', {className: 'text-green-300 mb-2'}, 
                                'Dalle ', new Date(currentStaff.checkInTime).toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'}),
                                ' â€¢ ', getWorkedHours(), 'h'
                            ),
                            h('button', {
                                onClick: toggleMyCheckIn,
                                className: 'w-full py-4 rounded-xl font-bold text-xl mt-4 ' + (isOnDuty ? 'bg-red-500 hover:bg-red-600 text-white' : 'bg-green-500 hover:bg-green-600 text-white')
                            }, isOnDuty ? 'â¹ CHECK-OUT' : 'â–¶ CHECK-IN')
                        ),

                        // Today stats (for waiters)
                        isWaiter && h('div', {className: 'grid grid-cols-3 gap-3'},
                            h('div', {className: 'bg-pink-500/20 rounded-xl p-4 text-center'},
                                h('div', {className: 'text-pink-300 text-xs'}, 'Ordini'),
                                h('div', {className: 'text-white font-bold text-2xl'}, orders.length)
                            ),
                            h('div', {className: 'bg-orange-500/20 rounded-xl p-4 text-center'},
                                h('div', {className: 'text-orange-300 text-xs'}, 'Chiamate'),
                                h('div', {className: 'text-white font-bold text-2xl'}, calls.length)
                            ),
                            h('div', {className: 'bg-yellow-500/20 rounded-xl p-4 text-center'},
                                h('div', {className: 'text-yellow-300 text-xs'}, 'Ore'),
                                h('div', {className: 'text-white font-bold text-2xl'}, getWorkedHours())
                            )
                        ),

                        // Quick summary for non-waiters
                        !isWaiter && h('div', {className: 'bg-slate-800/50 border border-purple-500/30 rounded-xl p-6'},
                            h('h3', {className: 'text-white font-bold mb-4'}, 'ðŸ“Š Il tuo turno'),
                            h('div', {className: 'space-y-3'},
                                h('div', {className: 'flex justify-between'}, 
                                    h('span', {className: 'text-purple-300'}, 'Ore lavorate'),
                                    h('span', {className: 'text-white font-bold'}, getWorkedHours(), 'h')
                                ),
                                currentStaff.hourlyRate && h('div', {className: 'flex justify-between'}, 
                                    h('span', {className: 'text-purple-300'}, 'Guadagno stimato'),
                                    h('span', {className: 'text-green-400 font-bold'}, 'â‚¬', (getWorkedHours() * currentStaff.hourlyRate).toFixed(2))
                                )
                            )
                        )
                    ),

                    // ORDERS TAB (waiters only)
                    tab === 'orders' && isWaiter && h('div', {className: 'space-y-4'},
                        // Pending orders
                        h('div', {},
                            h('h2', {className: 'text-white font-bold mb-3 flex items-center gap-2'}, 
                                h('span', {className: 'w-3 h-3 rounded-full bg-yellow-500'}), 
                                'Nuovi Ordini (', pendingOrders.length, ')'
                            ),
                            pendingOrders.length === 0 
                                ? h('p', {className: 'text-purple-300 text-center py-4 bg-slate-800/30 rounded-xl'}, 'Nessun ordine in attesa')
                                : pendingOrders.sort(function(a,b) { return new Date(a.createdAt) - new Date(b.createdAt); }).map(function(order) {
                                    var table = tables.find(function(t) { return t.id === order.tableId; });
                                    return h('div', {key: order.id, className: 'bg-yellow-500/20 border-2 border-yellow-400 rounded-xl p-4 mb-3'},
                                        h('div', {className: 'flex justify-between items-start mb-3'},
                                            h('div', {},
                                                h('span', {className: 'text-2xl font-black text-white'}, 'Tavolo ', table ? table.number : '?'),
                                                h('p', {className: 'text-yellow-200 text-sm'}, timeSince(order.createdAt))
                                            ),
                                            h('span', {className: 'bg-yellow-500 text-white text-xs px-2 py-1 rounded-full font-bold'}, 'NUOVO')
                                        ),
                                        h('div', {className: 'bg-slate-900/50 rounded-lg p-3 mb-3'},
                                            h('div', {className: 'text-white font-bold text-lg'}, order.quantity, 'x ', order.productName),
                                            h('div', {className: 'text-yellow-300'}, 'â‚¬', order.total ? order.total.toFixed(2) : '0.00')
                                        ),
                                        h('div', {className: 'flex gap-2'},
                                            h('button', {
                                                onClick: function() { updateOrderStatus(order.id, 'preparing'); },
                                                className: 'flex-1 bg-blue-500 text-white py-2 rounded-lg font-bold'
                                            }, 'ðŸ‘¨â€ðŸ³ Prepara'),
                                            h('button', {
                                                onClick: function() { updateOrderStatus(order.id, 'served'); },
                                                className: 'flex-1 bg-green-500 text-white py-2 rounded-lg font-bold'
                                            }, 'âœ“ Servito')
                                        )
                                    );
                                })
                        ),

                        // Preparing orders
                        preparingOrders.length > 0 && h('div', {},
                            h('h2', {className: 'text-white font-bold mb-3 flex items-center gap-2'}, 
                                h('span', {className: 'w-3 h-3 rounded-full bg-blue-500'}), 
                                'In Preparazione (', preparingOrders.length, ')'
                            ),
                            preparingOrders.map(function(order) {
                                var table = tables.find(function(t) { return t.id === order.tableId; });
                                return h('div', {key: order.id, className: 'bg-blue-500/20 border border-blue-400/50 rounded-xl p-4 mb-3'},
                                    h('div', {className: 'flex justify-between items-center'},
                                        h('div', {},
                                            h('span', {className: 'text-white font-bold'}, 'Tavolo ', table ? table.number : '?'),
                                            h('span', {className: 'text-blue-300 ml-2'}, order.quantity, 'x ', order.productName)
                                        ),
                                        h('button', {
                                            onClick: function() { updateOrderStatus(order.id, 'served'); },
                                            className: 'bg-green-500 text-white px-3 py-1 rounded-lg text-sm font-bold'
                                        }, 'âœ“ Servito')
                                    )
                                );
                            })
                        ),

                        // Ready orders
                        readyOrders.length > 0 && h('div', {},
                            h('h2', {className: 'text-white font-bold mb-3 flex items-center gap-2'}, 
                                h('span', {className: 'w-3 h-3 rounded-full bg-green-500 animate-pulse'}), 
                                'Pronti da Servire (', readyOrders.length, ')'
                            ),
                            readyOrders.map(function(order) {
                                var table = tables.find(function(t) { return t.id === order.tableId; });
                                return h('div', {key: order.id, className: 'bg-green-500/20 border-2 border-green-400 rounded-xl p-4 mb-3'},
                                    h('div', {className: 'flex justify-between items-center'},
                                        h('div', {},
                                            h('span', {className: 'text-xl font-black text-white'}, 'ðŸ“ Tavolo ', table ? table.number : '?'),
                                            h('p', {className: 'text-green-300'}, order.quantity, 'x ', order.productName)
                                        ),
                                        h('button', {
                                            onClick: function() { updateOrderStatus(order.id, 'served'); },
                                            className: 'bg-green-500 text-white px-4 py-2 rounded-lg font-bold'
                                        }, 'âœ“ Consegnato')
                                    )
                                );
                            })
                        )
                    ),

                    // CALLS TAB (waiters only)
                    tab === 'calls' && isWaiter && h('div', {className: 'space-y-3'},
                        calls.length === 0 
                            ? h('div', {className: 'text-center py-16'},
                                h('div', {className: 'text-6xl mb-4'}, 'ðŸ””'),
                                h('p', {className: 'text-white font-bold'}, 'Nessuna chiamata'),
                                h('p', {className: 'text-purple-300 text-sm'}, 'Le chiamate appariranno qui')
                            )
                            : calls.sort(function(a,b) { return new Date(a.createdAt) - new Date(b.createdAt); }).map(function(call) {
                                return h('div', {key: call.id, className: 'call-pulse bg-orange-500/20 border-2 border-orange-400 rounded-xl p-4'},
                                    h('div', {className: 'flex justify-between items-start mb-3'},
                                        h('div', {},
                                            h('span', {className: 'text-3xl font-black text-white'}, 'Tavolo ', call.tableNumber),
                                            h('p', {className: 'text-orange-200 text-sm mt-1'}, timeSince(call.createdAt))
                                        ),
                                        h('span', {className: 'text-2xl'}, 'ðŸ””')
                                    ),
                                    h('button', {
                                        onClick: function() { clearCall(call.id); },
                                        className: 'w-full bg-green-500 text-white py-3 rounded-lg font-bold text-lg'
                                    }, 'âœ“ Servito')
                                );
                            })
                    ),

                    // TABLES TAB (waiters only)
                    tab === 'tables' && isWaiter && h('div', {className: 'space-y-3'},
                        tables.sort(function(a,b) { return a.number - b.number; }).map(function(table) {
                            var booking = bookings.find(function(b) { return b.tableId === table.id; });
                            var tableOrders = orders.filter(function(o) { return o.tableId === table.id; });
                            var pendingCount = tableOrders.filter(function(o) { return !o.status || o.status === 'pending'; }).length;
                            var total = tableOrders.reduce(function(s, o) { return s + (o.total || 0); }, 0);
                            var hasCall = calls.some(function(c) { return c.tableId === table.id; });
                            
                            return h('div', {key: table.id, className: 'rounded-xl p-4 border-2 ' + (hasCall ? 'bg-orange-500/20 border-orange-400' : booking ? 'bg-green-500/10 border-green-500/40' : 'bg-slate-800/50 border-purple-500/30')},
                                h('div', {className: 'flex justify-between items-start'},
                                    h('div', {},
                                        h('span', {className: 'text-white font-bold text-xl'}, 'Tavolo ', table.number, hasCall ? ' ðŸ””' : ''),
                                        booking 
                                            ? h('p', {className: 'text-green-300 text-sm'}, 'ðŸ‘¤ ', booking.guestName)
                                            : h('p', {className: 'text-purple-400 text-sm'}, 'Libero â€¢ ', table.capacity, ' posti'),
                                        pendingCount > 0 && h('p', {className: 'text-yellow-400 text-sm font-bold'}, 'â³ ', pendingCount, ' ordini in attesa')
                                    ),
                                    total > 0 && h('div', {className: 'text-right'},
                                        h('div', {className: 'text-yellow-400 font-bold'}, 'â‚¬', total.toFixed(2)),
                                        h('div', {className: 'text-purple-300 text-xs'}, tableOrders.length, ' ordini')
                                    )
                                )
                            );
                        })
                    )
                ),

                // Floating notification for calls (waiters only)
                isWaiter && calls.length > 0 && tab !== 'calls' && h('button', {
                    onClick: function() { setTab('calls'); },
                    className: 'fixed bottom-6 right-6 bg-orange-500 text-white px-6 py-4 rounded-full shadow-lg flex items-center gap-2 animate-bounce'
                }, 'ðŸ”” ', calls.length)
            );
        }

        ReactDOM.render(h(App), document.getElementById('root'));
    </script>
</body>
</html>
